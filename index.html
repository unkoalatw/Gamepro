<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å°¾åˆ€æ ¸å¿ƒ | å°ˆæ¥­é›»ç«¶é™ªç©ä»£æ‰“å¹³å°</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@300;400;700&display=swap');
        body { font-family: 'Noto Sans TC', sans-serif; }
        .glass { background: rgba(30, 41, 59, 0.9); backdrop-filter: blur(12px); border: 1px solid rgba(255, 255, 255, 0.1); }
        .hero-bg { 
            background-image: linear-gradient(rgba(0,0,0,0.6), rgba(0,0,0,0.8)), url('https://images.unsplash.com/photo-1542751371-adc38448a05e?ixlib=rb-1.2.1&auto=format&fit=crop&w=1920&q=80'); 
            background-size: cover; background-position: center; background-attachment: fixed;
        }
        .luxury-bg { background: linear-gradient(-45deg, #1e1b4b, #312e81, #4c1d95, #0f172a); background-size: 400% 400%; animation: gradient-xy 15s ease infinite; }
        @keyframes gradient-xy { 0%, 100% { background-position: 0% 50%; } 50% { background-position: 100% 50%; } }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        ::-webkit-calendar-picker-indicator { filter: invert(1); cursor: pointer; opacity: 0.8; }
        ::-webkit-calendar-picker-indicator:hover { opacity: 1; }
    </style>
</head>
<body class="bg-slate-900 text-white min-h-screen" onload="initApp()">

    <nav class="fixed w-full z-40 glass border-b border-slate-700/50">
        <div class="max-w-7xl mx-auto px-6 h-16 flex justify-between items-center">
            <div class="flex items-center cursor-pointer" onclick="window.scrollTo(0,0)">
                <i class="fa-solid fa-gamepad text-purple-500 text-2xl mr-3"></i>
                <span class="font-bold text-xl tracking-wider">å°¾åˆ€æ ¸å¿ƒ</span>
            </div>
            <div>
                <button onclick="openOrderHub()" class="bg-slate-800/80 hover:bg-purple-600 px-5 py-2 rounded-full text-sm transition border border-slate-600 hover:border-purple-500 flex items-center gap-2">
                    <i class="fa-solid fa-user-astronaut"></i> <span id="navBtnText">æŸ¥è©¢è¨‚å–®</span>
                </button>
            </div>
        </div>
    </nav>

    <div class="hero-bg h-screen flex items-center justify-center text-center px-4 relative">
        <div class="max-w-4xl space-y-8">
            <h1 class="text-6xl md:text-8xl font-bold text-transparent bg-clip-text bg-gradient-to-r from-purple-400 via-pink-500 to-red-500 drop-shadow-[0_0_15px_rgba(168,85,247,0.5)]">å°¾åˆ€æ ¸å¿ƒ</h1>
            <p class="text-xl md:text-2xl text-gray-200 font-light">ä½ çš„å°ˆå±¬é›»ç«¶ç®¡å®¶</p>
            <button onclick="scrollToOrder()" class="mt-8 group relative inline-flex items-center justify-center px-10 py-4 text-lg font-bold text-white bg-gradient-to-r from-purple-600 to-blue-600 rounded-full hover:scale-105 transition shadow-lg">
                <span>é–‹å§‹é»å–®</span> <i class="fa-solid fa-arrow-down ml-2 group-hover:translate-y-1 transition-transform"></i>
            </button>
        </div>
    </div>

    <div id="bookingSection" class="min-h-screen bg-slate-900 py-24 px-4 hidden">
        <div class="max-w-4xl mx-auto">
            <div class="glass p-8 md:p-12 rounded-3xl shadow-2xl border-t border-white/10 relative">
                <h2 class="text-3xl font-bold mb-8 flex items-center"><span class="bg-purple-600 w-1.5 h-8 mr-4 rounded-full"></span> é ç´„æœå‹™å–®</h2>
                
                <form id="bookingForm" class="space-y-8">
                    <!-- 1. Game -->
                    <div>
                        <label class="text-purple-300 text-sm font-bold uppercase tracking-wider mb-3 block">01. é¸æ“‡éŠæˆ² <span class="text-red-500">*</span></label>
                        <select id="gameSelect" onchange="onGameChange()" class="w-full bg-slate-800/50 border border-slate-600 rounded-xl px-5 py-4 text-white focus:ring-2 focus:ring-purple-500 outline-none transition text-lg">
                            <option value="">è¼‰å…¥ä¸­...</option>
                        </select>
                        <p id="mockDataMsg" class="text-yellow-400 text-xs mt-2 hidden"><i class="fas fa-wifi mr-1"></i>å±•ç¤ºæ¨¡å¼</p>
                    </div>

                    <!-- 2. Booster -->
                    <div id="boosterSection" class="hidden">
                        <label class="text-purple-300 text-sm font-bold uppercase tracking-wider mb-3 block">02. é¸æ“‡é™ªç©å¸« / å¤§ç¥</label>
                        <div id="boosterGrid" class="grid grid-cols-2 md:grid-cols-4 gap-4"></div>
                        <input type="hidden" id="selectedBoosterId" value="">
                        <input type="hidden" id="selectedBoosterName" value="">
                        <input type="hidden" id="selectedBoosterPrice" value="0">
                    </div>

                    <!-- 3. Service Type -->
                    <div>
                        <label class="text-purple-300 text-sm font-bold uppercase tracking-wider mb-3 block">03. æœå‹™é¡å‹</label>
                        <div id="serviceTypeContainer" class="grid grid-cols-2 gap-4"></div>
                    </div>

                    <!-- 4. Dynamic Content: Hours (Companion) OR Request (Boost) -->
                    <div id="dynamicServiceSection" class="grid md:grid-cols-2 gap-6">
                        
                        <!-- A. Hours Selector (For Companion) -->
                        <div id="hoursSection">
                            <label class="text-purple-300 text-sm font-bold uppercase tracking-wider mb-3 block">04. é ç´„æ™‚æ•¸ <span class="text-red-500">*</span></label>
                            <div class="bg-slate-800/50 border border-slate-600 rounded-xl px-5 py-3 flex items-center justify-between">
                                <button type="button" onclick="changeHours(-1)" class="w-8 h-8 bg-slate-700 rounded-full hover:bg-purple-600 transition">-</button>
                                <div class="text-center">
                                    <span id="displayHours" class="text-2xl font-bold text-white">1</span> <span class="text-sm text-gray-400">å°æ™‚</span>
                                </div>
                                <button type="button" onclick="changeHours(1)" class="w-8 h-8 bg-slate-700 rounded-full hover:bg-purple-600 transition">+</button>
                            </div>
                            <!-- åƒ¹æ ¼é è¦½ -->
                            <div id="pricePreview" class="mt-2 text-right hidden">
                                <span class="text-gray-400 text-sm">é ä¼°é‡‘é¡:</span> 
                                <span id="totalPriceDisplay" class="text-2xl font-bold text-green-400">$0</span>
                            </div>
                        </div>

                        <!-- B. Boost Request Textarea (For Boost) -->
                        <div id="requestSection" class="hidden md:col-span-2">
                            <label class="text-purple-300 text-sm font-bold uppercase tracking-wider mb-3 block">04. ä»£æ‰“éœ€æ±‚æè¿° <span class="text-red-500">*</span></label>
                            <textarea id="boostRequestInput" rows="3" class="w-full bg-slate-800/50 border border-slate-600 rounded-xl px-5 py-3 text-white focus:ring-2 focus:ring-purple-500 outline-none" placeholder="ä¾‹å¦‚ï¼šç›®å‰éŠ€ç‰Œ2ï¼Œæƒ³æ‰“åˆ°é‡‘ç‰Œ4ã€‚è«‹å¹«æˆ‘å ±åƒ¹ã€‚"></textarea>
                            <div class="mt-2 text-right">
                                <span class="text-gray-400 text-sm">é‡‘é¡:</span> 
                                <span class="text-xl font-bold text-yellow-400">ç­‰å¾…å¤§ç¥å ±åƒ¹</span>
                            </div>
                        </div>

                    </div>

                    <!-- 5. Date & Time -->
                    <div class="grid md:grid-cols-2 gap-6">
                        <div>
                            <label class="text-gray-400 text-sm mb-2 block">é ç´„/é–‹æ‰“æ—¥æœŸ <span class="text-red-500">*</span></label>
                            <input type="date" id="dateInput" class="w-full bg-slate-800/50 border border-slate-600 rounded-xl px-5 py-3 text-white focus:ring-2 focus:ring-purple-500 outline-none cursor-pointer">
                        </div>
                        <div>
                            <label class="text-gray-400 text-sm mb-2 block">é è¨ˆé–‹å§‹æ™‚é–“ <span class="text-red-500">*</span></label>
                            <input type="time" id="timeInput" class="w-full bg-slate-800/50 border border-slate-600 rounded-xl px-5 py-3 text-white focus:ring-2 focus:ring-purple-500 outline-none cursor-pointer">
                        </div>
                    </div>

                    <!-- 6. Email -->
                    <div>
                        <label class="text-gray-400 text-sm mb-2 block">è¯çµ¡ Email <span class="text-red-500">*</span></label>
                        <input type="email" id="emailInput" placeholder="example@gmail.com" class="w-full bg-slate-800/50 border border-slate-600 rounded-xl px-5 py-3 text-white focus:ring-2 focus:ring-purple-500 outline-none">
                    </div>

                    <button type="button" onclick="submitInquiry()" class="w-full bg-gradient-to-r from-purple-600 to-pink-600 hover:from-purple-500 hover:to-pink-500 text-white font-bold py-4 rounded-xl shadow-lg transition transform hover:scale-[1.01] flex justify-center items-center gap-2">
                        <span>é€å‡ºéœ€æ±‚å–®</span> <i class="fa-solid fa-paper-plane"></i>
                    </button>
                </form>
            </div>
        </div>
    </div>

    <!-- Created Modal -->
    <div id="createdModal" class="fixed inset-0 bg-black/90 hidden items-center justify-center z-[60] backdrop-blur-sm">
        <div class="bg-slate-800 p-8 rounded-3xl w-full max-w-sm text-center border-2 border-purple-500 shadow-[0_0_50px_rgba(168,85,247,0.4)] animate-bounce-in relative">
            <div class="w-20 h-20 bg-green-500 rounded-full flex items-center justify-center mx-auto mb-6 shadow-lg">
                <i class="fa-solid fa-check text-4xl text-white"></i>
            </div>
            <h3 class="text-2xl font-bold text-white mb-2">éœ€æ±‚å·²é€å‡ºï¼</h3>
            <p class="text-gray-400 text-sm mb-6">å¤§ç¥å°‡åœ¨ç¢ºèªéœ€æ±‚å¾Œç‚ºæ‚¨å ±åƒ¹ã€‚<br>è«‹è¨˜ä¸‹å–®è™Ÿä»¥æŸ¥è©¢é€²åº¦ã€‚</p>
            
            <div class="bg-slate-900 rounded-xl p-4 mb-6 border border-slate-700 relative group cursor-pointer" onclick="copyCreatedId()">
                <p class="text-xs text-gray-500 mb-1 uppercase tracking-wider">Order ID</p>
                <div class="flex items-center justify-center gap-2">
                    <span id="createdOrderIdText" class="text-3xl font-mono font-bold text-purple-400">---</span>
                    <i class="fa-regular fa-copy text-gray-500 group-hover:text-white transition"></i>
                </div>
            </div>

            <button onclick="goToHubFromCreated()" class="w-full bg-gradient-to-r from-purple-600 to-blue-600 hover:from-purple-500 hover:to-blue-500 text-white font-bold py-3 rounded-xl shadow-lg transition">
                å‰å¾€è¨‚å–®ä¸­å¿ƒ <i class="fa-solid fa-arrow-right ml-2"></i>
            </button>
        </div>
    </div>

    <!-- Order Hub -->
    <div id="orderHub" class="fixed inset-0 z-50 hidden luxury-bg overflow-y-auto">
        <button onclick="closeOrderHub()" class="absolute top-6 right-6 z-50 bg-white/10 hover:bg-white/20 text-white w-10 h-10 rounded-full flex items-center justify-center transition backdrop-blur-md"><i class="fa-solid fa-xmark text-xl"></i></button>
        <div class="min-h-screen flex flex-col items-center justify-center p-4">
            <div id="hubSearch" class="w-full max-w-md text-center space-y-8">
                <h2 class="text-3xl font-bold text-white">æŸ¥è©¢è¨‚å–®</h2>
                <div class="flex bg-slate-900 rounded-xl p-2 border border-slate-700">
                    <input type="text" id="hubOrderIdInput" placeholder="ORD-123456" class="flex-1 bg-transparent px-4 text-white focus:outline-none">
                    <button onclick="checkStatusInHub()" class="bg-purple-600 px-6 py-2 rounded-lg font-bold text-white">æŸ¥è©¢</button>
                </div>
            </div>
            <div id="hubResult" class="w-full max-w-5xl hidden grid grid-cols-1 lg:grid-cols-3 gap-8">
                <div class="lg:col-span-1 space-y-6">
                    <div class="glass rounded-3xl p-8 text-center border-t-4 border-purple-500 relative">
                        <div id="statusIcon" class="w-20 h-20 bg-slate-800 rounded-full flex items-center justify-center mx-auto mb-4 text-3xl"><i class="fa-solid fa-spinner fa-spin"></i></div>
                        <h3 id="statusTitle" class="text-2xl font-bold text-white">è®€å–ä¸­...</h3>
                        <div class="text-purple-300 font-mono mt-2" id="displayOrderId"></div>
                        
                        <div id="userCancelArea" class="mt-6 hidden">
                            <button onclick="cancelOrderUser()" class="text-red-400 hover:text-red-300 border border-red-500/30 hover:bg-red-500/10 px-4 py-2 rounded-lg text-sm transition w-full">
                                <i class="fa-solid fa-ban mr-2"></i> å–æ¶ˆè¨‚å–®
                            </button>
                        </div>

                        <div id="boosterIdCard" class="hidden mt-6 bg-purple-900/40 p-4 rounded-xl border border-purple-500/50 animate-pulse">
                            <p class="text-xs text-purple-200 mb-2 font-bold uppercase tracking-widest">å¤§ç¥éŠæˆ² ID</p>
                            <div class="flex items-center justify-between bg-black/40 p-3 rounded-lg border border-white/10 group cursor-pointer hover:bg-black/50 transition" onclick="copyBoosterId()">
                                <span id="displayBoosterId" class="font-mono font-bold text-white text-lg select-all tracking-wide">---</span>
                                <i class="fa-regular fa-copy text-gray-400 group-hover:text-white"></i>
                            </div>
                        </div>
                    </div>
                    <div id="paymentActionArea" class="glass rounded-3xl p-6 hidden">
                        <h4 class="text-green-400 font-bold mb-2">è¨‚å–®ç¢ºèªï¼è«‹ä»˜æ¬¾</h4>
                        <div class="mb-4 p-3 bg-slate-800 rounded-lg flex justify-between items-center">
                            <span class="text-gray-400">æ‡‰ä»˜é‡‘é¡:</span>
                            <span id="payAmountDisplay" class="text-2xl font-bold text-white">$0</span>
                        </div>
                        <input type="text" id="payCard" placeholder="MyCard å¡è™Ÿ" class="w-full bg-slate-900 border border-slate-600 rounded mb-2 px-3 py-2 text-white">
                        <input type="text" id="payPwd" placeholder="MyCard å¯†ç¢¼" class="w-full bg-slate-900 border border-slate-600 rounded mb-2 px-3 py-2 text-white">
                        <button onclick="submitPayment()" class="w-full bg-green-600 py-2 rounded text-white font-bold">ç¢ºèªä»˜æ¬¾</button>
                    </div>
                </div>
                <div class="lg:col-span-2 glass rounded-3xl overflow-hidden flex flex-col h-[600px]">
                    <div class="bg-slate-900/50 p-4 border-b border-white/5 font-bold">å®¢æœå°è©±</div>
                    <div id="chatBox" class="flex-1 overflow-y-auto p-6 space-y-4"></div>
                    <div class="p-4 bg-slate-900/80 flex gap-2">
                        <input type="text" id="chatMsg" class="flex-1 bg-slate-800 border border-slate-600 rounded-xl px-4 py-3 text-white" placeholder="è¼¸å…¥è¨Šæ¯...">
                        <button onclick="sendUserMessage()" class="bg-purple-600 w-12 h-12 rounded-xl text-white"><i class="fa-solid fa-paper-plane"></i></button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        const GAS_API_URL = "https://script.google.com/macros/s/AKfycbxm6I0lCN82Tnt3gDWPNKptKO9682Jeik-XSJlb9YTGTG4HkY5d-GfwK75HVHWVhQP8/exec";
        
        let allGames = [];
        let currentOrderId = "";
        let isMockMode = false;
        let currentHours = 1;
        let currentServiceType = 'companion'; 
        let lastKnownStatus = "";
        let lastMsgCount = 0;

        function initApp() {
            document.getElementById('dateInput').valueAsDate = new Date();
            fetchGames();
            
            const savedId = getCookie("gcarry_order");
            if(savedId) {
                document.getElementById('navBtnText').innerText = `æŸ¥è©¢ (${savedId})`;
                openOrderHub(savedId); 
            }
        }

        function requestNotificationPermission() {
            if (!("Notification" in window)) return;
            if (Notification.permission === "default") Notification.requestPermission();
        }
        function sendNotification(title, body) {
            if (Notification.permission === "granted") new Notification(title, { body: body, icon: "https://cdn-icons-png.flaticon.com/512/3225/3225132.png" });
        }

        function fetchGames() {
            fetch(GAS_API_URL + "?action=getGames")
                .then(r => r.ok ? r.json() : Promise.reject())
                .then(data => renderGames(data))
                .catch(() => {
                    isMockMode = true;
                    document.getElementById('mockDataMsg').classList.remove('hidden');
                    renderGames([{id:'lol', name:'è‹±é›„è¯ç›Ÿ (Demo)', companion:true, boost:true}]);
                });
        }

        function renderGames(data) {
            allGames = data;
            const sel = document.getElementById('gameSelect');
            sel.innerHTML = data.length ? data.map(g => `<option value="${g.id}">${g.name}</option>`).join('') : '<option value="">ç„¡éŠæˆ²</option>';
            onGameChange(); 
        }

        function onGameChange() { updateServiceOptions(); fetchBoosters(); }

        function updateServiceOptions() {
            const gid = document.getElementById('gameSelect').value;
            const g = allGames.find(x => x.id === gid);
            if(!g) return;
            let h = '';
            if(g.companion) h += `<label class="cursor-pointer group"><input type="radio" name="serviceType" value="companion" checked class="peer sr-only" onclick="switchService('companion')"><div class="rounded-xl border border-slate-600 bg-slate-800/50 p-4 text-center peer-checked:border-pink-500 peer-checked:bg-pink-900/20 peer-checked:text-pink-400 hover:bg-slate-700 transition"><i class="fa-solid fa-microphone-lines text-2xl mb-1"></i><div class="font-bold">èªéŸ³é™ªç©</div></div></label>`;
            if(g.boost) h += `<label class="cursor-pointer group"><input type="radio" name="serviceType" value="boost" class="peer sr-only" onclick="switchService('boost')"><div class="rounded-xl border border-slate-600 bg-slate-800/50 p-4 text-center peer-checked:border-yellow-500 peer-checked:bg-yellow-900/20 peer-checked:text-yellow-400 hover:bg-slate-700 transition"><i class="fa-solid fa-trophy text-2xl mb-1"></i><div class="font-bold">æŠ€è¡“ä»£æ‰“</div></div></label>`;
            document.getElementById('serviceTypeContainer').innerHTML = h;
            
            if(g.companion) switchService('companion');
            else if(g.boost) switchService('boost');
        }

        function switchService(type) {
            currentServiceType = type;
            const hoursSec = document.getElementById('hoursSection');
            const reqSec = document.getElementById('requestSection');
            
            if (!hoursSec || !reqSec) {
                console.warn("DOM elements missing for service switch");
                return;
            }
            
            if(type === 'companion') {
                hoursSec.classList.remove('hidden');
                reqSec.classList.add('hidden');
                updatePricePreview(); 
            } else {
                hoursSec.classList.add('hidden');
                reqSec.classList.remove('hidden');
            }
        }

        function fetchBoosters() {
            const gid = document.getElementById('gameSelect').value;
            const section = document.getElementById('boosterSection');
            const grid = document.getElementById('boosterGrid');
            section.classList.remove('hidden');
            grid.innerHTML = '<div class="col-span-full text-center text-gray-400"><i class="fa-solid fa-circle-notch fa-spin"></i> è¼‰å…¥å¤§ç¥ä¸­...</div>';
            selectBooster('','',0); 
            if(isMockMode) { setTimeout(() => renderBoosters(getMockBoosters(gid)), 500); return; }
            fetch(GAS_API_URL + "?action=getBoosters&game=" + gid)
                .then(r => r.json()).then(data => renderBoosters(data)).catch(() => renderBoosters(getMockBoosters(gid)));
        }

        function renderBoosters(list) {
            const grid = document.getElementById('boosterGrid');
            let html = `
                <div onclick="selectBooster('','ç³»çµ±åˆ†é…', 0)" id="booster-random" class="cursor-pointer border-2 border-purple-500 bg-purple-900/30 p-4 rounded-xl text-center hover:scale-105 transition relative group">
                    <div class="w-16 h-16 bg-slate-700 rounded-full mx-auto mb-2 flex items-center justify-center text-2xl">â“</div>
                    <div class="font-bold text-white">ç³»çµ±åˆ†é…</div>
                    <div class="text-xs text-purple-300">å¿«é€Ÿé…å°</div>
                    <div class="absolute top-2 right-2 text-green-400"><i class="fa-solid fa-check-circle"></i></div>
                </div>
            `;
            if(list && list.length > 0) {
                html += list.map(b => `
                    <div onclick="selectBooster('${b.id}','${b.name}', '${b.price}')" id="booster-${b.id}" class="cursor-pointer border border-slate-600 bg-slate-800/50 p-4 rounded-xl text-center hover:border-purple-500 hover:bg-slate-800 transition relative group">
                        <div class="w-16 h-16 bg-slate-600 rounded-full mx-auto mb-2 overflow-hidden">
                            ${b.image ? `<img src="${b.image}" class="w-full h-full object-cover">` : `<div class="w-full h-full flex items-center justify-center text-2xl">ğŸ‘¤</div>`}
                        </div>
                        <div class="font-bold text-white truncate">${b.name}</div>
                        <div class="text-xs text-yellow-400 mb-1">${b.rank || 'å¤§ç¥'}</div>
                        <div class="text-xs text-green-400 bg-slate-900/50 rounded py-1 font-mono">$${b.price}/H</div>
                    </div>
                `).join('');
            }
            grid.innerHTML = html;
        }

        function selectBooster(id, name, price) {
            document.querySelectorAll('[id^="booster-"]').forEach(el => {
                el.classList.remove('border-2', 'border-purple-500', 'bg-purple-900/30');
                el.classList.add('border', 'border-slate-600', 'bg-slate-800/50');
            });
            const targetId = id ? `booster-${id}` : `booster-random`;
            const target = document.getElementById(targetId);
            if(target) {
                target.classList.remove('border', 'border-slate-600', 'bg-slate-800/50');
                target.classList.add('border-2', 'border-purple-500', 'bg-purple-900/30');
            }
            document.getElementById('selectedBoosterId').value = id;
            document.getElementById('selectedBoosterName').value = name;
            const cleanPrice = price ? parseInt(price.toString().replace(/\D/g, '')) : 0;
            document.getElementById('selectedBoosterPrice').value = cleanPrice || 0;
            updatePricePreview();
        }

        function changeHours(delta) {
            currentHours += delta;
            if(currentHours < 1) currentHours = 1;
            document.getElementById('displayHours').innerText = currentHours;
            updatePricePreview();
        }

        function updatePricePreview() {
            const price = parseInt(document.getElementById('selectedBoosterPrice').value) || 0;
            const total = price * currentHours;
            const preview = document.getElementById('pricePreview');
            const display = document.getElementById('totalPriceDisplay');
            if(currentServiceType === 'companion' && price > 0) { 
                preview.classList.remove('hidden'); 
                display.innerText = `$${total}`; 
            } else { 
                preview.classList.add('hidden'); 
            }
        }

        function getMockBoosters(gid) {
            if(gid === 'lol') return [{id:'b1', name:'Faker', rank:'èè‹±', price:'200'}, {id:'b2', name:'Keria', rank:'å®—å¸«', price:'180'}];
            return [];
        }

        function submitInquiry() {
            const btn = document.querySelector('button[onclick="submitInquiry()"]');
            const orgTxt = btn.innerHTML;
            
            let totalPrice = 0;
            let noteStr = "";

            if(currentServiceType === 'companion') {
                const boosterPrice = parseInt(document.getElementById('selectedBoosterPrice').value) || 0;
                totalPrice = boosterPrice * currentHours;
            } else {
                currentHours = 0; 
                totalPrice = 0;
                const requestText = document.getElementById('boostRequestInput').value;
                if(!requestText) { alert("è«‹å¡«å¯«ä»£æ‰“éœ€æ±‚æè¿°ï¼"); return; }
                noteStr = " [ä»£æ‰“éœ€æ±‚: " + requestText + "]"; 
            }

            const form = {
                action: 'createInquiry',
                game: document.getElementById('gameSelect').value,
                type: currentServiceType,
                boosterId: document.getElementById('selectedBoosterId').value,
                boosterName: document.getElementById('selectedBoosterName').value + noteStr, 
                date: document.getElementById('dateInput').value,
                time: document.getElementById('timeInput').value,
                email: document.getElementById('emailInput').value,
                hours: currentHours,
                totalPrice: totalPrice
            };

            if(!form.game) { alert("è«‹é¸æ“‡éŠæˆ²ï¼"); return; }
            if(!form.date) { alert("è«‹é¸æ“‡æ—¥æœŸï¼"); return; }
            if(!form.time) { alert("è«‹é¸æ“‡æ™‚é–“ï¼"); return; }
            if(!form.email) { alert("è«‹å¡«å¯« Emailï¼"); return; }

            btn.innerHTML = '<i class="fa-solid fa-spinner fa-spin"></i>...'; btn.disabled = true;

            if(isMockMode) { setTimeout(() => { showCreatedModal("DEMO-123"); btn.innerHTML=orgTxt; btn.disabled=false; }, 1000); return; }

            fetch(GAS_API_URL, {method:'POST', body:JSON.stringify(form)})
                .then(r=>r.json()).then(d=>{
                    if(d.status==='success') showCreatedModal(d.orderId);
                    else alert(d.message);
                })
                .finally(()=>{ btn.innerHTML=orgTxt; btn.disabled=false; });
        }

        function scrollToOrder() { document.getElementById('bookingSection').classList.remove('hidden'); document.getElementById('bookingSection').scrollIntoView({behavior:'smooth'}); }
        
        function showCreatedModal(orderId) {
            currentOrderId = orderId;
            document.getElementById('createdOrderIdText').innerText = orderId;
            document.getElementById('createdModal').classList.remove('hidden');
            document.getElementById('createdModal').classList.add('flex');
            setCookie("gcarry_order", orderId, 7);
        }

        function copyTextToClipboard(text) {
            const textArea = document.createElement("textarea");
            textArea.value = text;
            textArea.style.position = "fixed";
            textArea.style.left = "-9999px";
            textArea.style.top = "0";
            document.body.appendChild(textArea);
            textArea.focus();
            textArea.select();
            try {
                const successful = document.execCommand('copy');
                document.body.removeChild(textArea);
                if (successful) return Promise.resolve();
                else return Promise.reject("è¤‡è£½å¤±æ•—");
            } catch (err) {
                document.body.removeChild(textArea);
                return Promise.reject(err);
            }
        }

        function copyCreatedId() {
            const text = document.getElementById('createdOrderIdText').innerText;
            copyTextToClipboard(text).then(() => alert("å·²è¤‡è£½å–®è™Ÿï¼")).catch(e => alert("è¤‡è£½å¤±æ•—ï¼Œè«‹æ‰‹å‹•è¤‡è£½"));
        }

        function copyBoosterId() {
            const text = document.getElementById('displayBoosterId').innerText;
            copyTextToClipboard(text).then(() => alert("å·²è¤‡è£½ ID"));
        }

        function goToHubFromCreated() {
            document.getElementById('createdModal').classList.add('hidden');
            document.getElementById('createdModal').classList.remove('flex');
            openOrderHub(currentOrderId);
        }

        function openOrderHub(id="") { 
            document.getElementById('orderHub').classList.remove('hidden'); 
            requestNotificationPermission();
            if(id) { 
                document.getElementById('hubSearch').classList.add('hidden'); 
                document.getElementById('hubResult').classList.remove('hidden'); 
                lastKnownStatus = "";
                lastMsgCount = 0;
                checkStatusReal(id, true); 
            }
        }
        function closeOrderHub() { document.getElementById('orderHub').classList.add('hidden'); }
        function checkStatusInHub() { const id=document.getElementById('hubOrderIdInput').value; if(id) openOrderHub(id); }
        
        function checkStatusReal(oid, isFirstLoad = false) {
            currentOrderId = oid;
            document.getElementById('displayOrderId').innerText = oid;
            if(isMockMode || oid.startsWith("DEMO")) { updateHubUI('WaitingPayment', 500, 'HideOnBush'); mockLoadChat(); return; }
            
            fetch(GAS_API_URL, {method:'POST', body:JSON.stringify({action:'checkStatus', orderId:oid})})
            .then(r=>r.json()).then(d=> { 
                if(d.status==='success'){ 
                    updateHubUI(d.orderStatus, d.totalPrice, d.boosterId);
                    
                    if (!isFirstLoad && lastKnownStatus && lastKnownStatus !== d.orderStatus) {
                        if (d.orderStatus === 'WaitingPayment') sendNotification("å°¾åˆ€æ ¸å¿ƒ é€šçŸ¥", "å¤§ç¥å·²æ¥å–®ï¼è«‹å‰å¾€ä»˜æ¬¾ã€‚");
                        if (d.orderStatus === 'Paid') sendNotification("å°¾åˆ€æ ¸å¿ƒ é€šçŸ¥", "ä»˜æ¬¾å·²ç¢ºèªï¼è¨‚å–®æˆç«‹ã€‚");
                        if (d.orderStatus === 'Cancelled') sendNotification("å°¾åˆ€æ ¸å¿ƒ é€šçŸ¥", "æ‚¨çš„è¨‚å–®å·²è¢«å–æ¶ˆã€‚");
                    }
                    lastKnownStatus = d.orderStatus;

                    loadChatMessages(); 
                } else if(isFirstLoad) { 
                    alert('æŸ¥ç„¡æ­¤å–®'); 
                } 
            });
        }

        function updateHubUI(s, price, boosterId) {
            const icon = document.getElementById('statusIcon');
            const pay = document.getElementById('paymentActionArea');
            const priceDisplay = document.getElementById('payAmountDisplay');
            const boosterCard = document.getElementById('boosterIdCard');
            const displayBooster = document.getElementById('displayBoosterId');
            const cancelArea = document.getElementById('userCancelArea'); 
            
            pay.classList.add('hidden');
            boosterCard.classList.add('hidden'); 
            cancelArea.classList.add('hidden'); 
            
            if(price && price > 0) priceDisplay.innerText = `$${price}`;
            else priceDisplay.innerText = "å¾…ç®¡ç†å“¡å ±åƒ¹";

            if(s==='Cancelled') { icon.innerHTML='<i class="fa-solid fa-ban"></i>'; icon.className="w-20 h-20 bg-red-500/20 text-red-400 rounded-full flex items-center justify-center mx-auto mb-4 text-3xl"; document.getElementById('statusTitle').innerText="è¨‚å–®å·²å–æ¶ˆ"; return;}
            
            if(s==='Inquiry') { 
                icon.innerHTML='<i class="fa-regular fa-clock"></i>'; 
                icon.className="w-20 h-20 bg-yellow-500/20 text-yellow-400 rounded-full flex items-center justify-center mx-auto mb-4 text-3xl"; 
                document.getElementById('statusTitle').innerText="å¯©æ ¸ / å ±åƒ¹ä¸­";
                cancelArea.classList.remove('hidden'); 
            }
            if(s==='WaitingPayment') { 
                icon.innerHTML='<i class="fa-solid fa-file-invoice-dollar"></i>'; 
                icon.className="w-20 h-20 bg-blue-500/20 text-blue-400 rounded-full flex items-center justify-center mx-auto mb-4 text-3xl animate-pulse"; 
                document.getElementById('statusTitle').innerText="ç­‰å¾…ä»˜æ¬¾"; 
                pay.classList.remove('hidden'); 
                cancelArea.classList.remove('hidden'); 
            }
            
            if(s==='Paid' || s==='Confirmed') { 
                icon.innerHTML='<i class="fa-solid fa-check"></i>'; 
                icon.className="w-20 h-20 bg-green-500/20 text-green-400 rounded-full flex items-center justify-center mx-auto mb-4 text-3xl"; 
                document.getElementById('statusTitle').innerText="è¨‚å–®å·²æˆç«‹";
                if(boosterId) {
                    boosterCard.classList.remove('hidden');
                    displayBooster.innerText = boosterId;
                }
            }
        }

        function cancelOrderUser() {
            if(!confirm("ç¢ºå®šè¦å–æ¶ˆæ­¤è¨‚å–®å—ï¼Ÿ")) return;
            const btn = document.querySelector('#userCancelArea button');
            const orgTxt = btn.innerText;
            btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> è™•ç†ä¸­...';
            btn.disabled = true;

            fetch(GAS_API_URL, {
                method: 'POST', 
                body: JSON.stringify({
                    action: 'userCancelOrder', 
                    orderId: currentOrderId
                })
            })
            .then(r => r.json())
            .then(d => {
                if(d.status === 'success') {
                    alert("è¨‚å–®å·²æˆåŠŸå–æ¶ˆã€‚");
                    checkStatusReal(currentOrderId); 
                } else {
                    alert("å–æ¶ˆå¤±æ•—ï¼š" + d.message);
                    btn.innerHTML = orgTxt;
                    btn.disabled = false;
                }
            })
            .catch(e => {
                alert("é€£ç·šéŒ¯èª¤ï¼Œè«‹ç¨å¾Œå†è©¦ã€‚");
                btn.innerHTML = orgTxt;
                btn.disabled = false;
            });
        }

        function submitPayment() { fetch(GAS_API_URL, {method:'POST', body:JSON.stringify({action:'submitPayment', orderId:currentOrderId, cardId:document.getElementById('payCard').value, cardPwd:document.getElementById('payPwd').value})}).then(r=>r.json()).then(d=>{ if(d.status==='success'){ alert('ä»˜æ¬¾å·²é€å‡º'); checkStatusReal(currentOrderId, true); }}); }
        
        function loadChatMessages() { 
            fetch(GAS_API_URL, {method:'POST', body:JSON.stringify({action:'getMessages', orderId:currentOrderId})})
            .then(r=>r.json()).then(d=>{
                renderChat(d.messages);
                if (lastMsgCount > 0 && d.messages.length > lastMsgCount) {
                    const lastMsg = d.messages[d.messages.length - 1];
                    if (lastMsg.sender === 'Admin') {
                        sendNotification("æ–°è¨Šæ¯", "å®¢æœ/å¤§ç¥ï¼š " + lastMsg.text);
                    }
                }
                lastMsgCount = d.messages.length;
            }); 
        }

        function renderChat(m) { document.getElementById('chatBox').innerHTML = m.map(x=>`<div class="mb-2 ${x.sender==='User'?'text-right':'text-left'}"><span class="px-3 py-2 rounded-xl text-sm ${x.sender==='User'?'bg-purple-600 text-white':'bg-slate-700 text-gray-200'}">${x.text}</span></div>`).join(''); }
        function sendUserMessage() { const t=document.getElementById('chatMsg').value; if(t) fetch(GAS_API_URL, {method:'POST', body:JSON.stringify({action:'sendMessage', orderId:currentOrderId, sender:'User', message:t})}).then(()=>{ document.getElementById('chatMsg').value=''; loadChatMessages(); }); }
        function mockLoadChat() { renderChat([{sender:'User', text:'Hi'}, {sender:'Admin', text:'æ­¡è¿!'}]); }
        function setCookie(n,v,d){const e=new Date();e.setTime(e.getTime()+(d*86400000));document.cookie=n+"="+v+";path=/;expires="+e.toUTCString();}
        function getCookie(n){const m=n+"=";const c=document.cookie.split(';');for(let i=0;i<c.length;i++){let x=c[i];while(x.charAt(0)==' ')x=x.substring(1);if(x.indexOf(m)==0)return x.substring(m.length,x.length);}return null;}
        function checkCookieForOrder(){const id=getCookie("gcarry_order"); if(id) document.getElementById('navBtnText').innerText = `æŸ¥è©¢ (${id})`;}
        
        setInterval(()=>{ 
            if(!document.getElementById('orderHub').classList.contains('hidden') && currentOrderId && !isMockMode && !currentOrderId.startsWith("DEMO")) {
                checkStatusReal(currentOrderId, false); 
            }
        }, 10000); 
    </script>
</body>
</html>