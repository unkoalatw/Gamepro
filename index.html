<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å°¾åˆ€æ ¸å¿ƒ | å°ˆæ¥­é›»ç«¶é™ªç©ä»£æ‰“å¹³å°</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@300;400;500;700&display=swap');
        
        /* --- Neumorphism é¢¨æ ¼è®Šæ•¸ --- */
        :root {
            --bg-base: #292d3e;      /* æ·±ç°è—åº•è‰² */
            --text-main: #e0e6ed;    /* äº®ç°ç™½æ–‡å­— */
            --text-sub: #94a3b8;     /* æ¬¡è¦æ–‡å­— */
            --accent: #a855f7;       /* ç´«è‰²é»ç¶´ */
            
            /* å‡¸èµ·é™°å½± (Raised) */
            --shadow-raised: 6px 6px 12px #212432, 
                             -6px -6px 12px #31364a;
            
            /* å‡¹é™·é™°å½± (Inset) */
            --shadow-inset: inset 6px 6px 12px #212432, 
                            inset -6px -6px 12px #31364a;
        }

        body { 
            font-family: 'Noto Sans TC', sans-serif; 
            background-color: var(--bg-base); 
            color: var(--text-main); 
        }

        /* --- Neu å…ƒä»¶æ¨£å¼ --- */
        
        .neu-card {
            background-color: var(--bg-base);
            border-radius: 1.5rem;
            box-shadow: var(--shadow-raised);
            border: 1px solid rgba(255, 255, 255, 0.05);
        }

        .neu-btn {
            background-color: var(--bg-base);
            color: var(--text-main);
            border-radius: 1rem;
            box-shadow: var(--shadow-raised);
            font-weight: bold;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            border: 1px solid rgba(255, 255, 255, 0.05);
        }
        .neu-btn:hover {
            color: var(--accent);
            transform: translateY(-2px);
        }
        .neu-btn:active {
            box-shadow: var(--shadow-inset);
            transform: translateY(0);
            color: var(--accent);
        }
        .neu-btn-primary {
            color: var(--accent);
        }

        .neu-input {
            background-color: var(--bg-base);
            border-radius: 0.75rem;
            box-shadow: var(--shadow-inset);
            border: none;
            color: var(--text-main);
            transition: all 0.3s ease;
        }
        .neu-input:focus {
            outline: none;
            box-shadow: inset 3px 3px 6px #212432, 
                        inset -3px -3px 6px #31364a,
                        0 0 0 2px var(--accent);
        }
        
        .neu-radio-label {
            cursor: pointer;
            border-radius: 1rem;
            box-shadow: var(--shadow-raised);
            transition: all 0.2s;
            border: 1px solid rgba(255, 255, 255, 0.02);
        }
        input:checked + .neu-radio-label {
            box-shadow: var(--shadow-inset);
            color: var(--accent);
        }

        .no-scrollbar::-webkit-scrollbar { display: none; }
        
        ::-webkit-calendar-picker-indicator { filter: invert(0.8); cursor: pointer; opacity: 0.6; }
        ::-webkit-calendar-picker-indicator:hover { opacity: 1; }

        @keyframes fade-in-up { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
        .animate-fade-in { animation: fade-in-up 0.5s cubic-bezier(0.2, 0.8, 0.2, 1); }
        
        .text-glow {
            text-shadow: 0 0 20px rgba(168, 85, 247, 0.5);
        }
        
        /* ä¿®æ­£ä¸‹æ‹‰é¸å–®é¸é …é¡è‰² */
        select option {
            background-color: #292d3e;
            color: #e0e6ed;
        }
    </style>
</head>
<body class="min-h-screen flex flex-col" onload="initApp()">

    <!-- Navbar -->
    <nav class="fixed w-full z-40 bg-[#292d3e]/90 backdrop-blur-md border-b border-white/5">
        <div class="max-w-7xl mx-auto px-6 h-20 flex justify-between items-center">
            <div class="flex items-center cursor-pointer" onclick="window.scrollTo(0,0)">
                <div class="w-10 h-10 rounded-xl flex items-center justify-center mr-3 text-purple-400" style="box-shadow: var(--shadow-raised);">
                    <i class="fa-solid fa-gamepad text-xl"></i>
                </div>
                <span class="font-bold text-2xl tracking-wide text-gray-200">å°¾åˆ€æ ¸å¿ƒ</span>
            </div>
            <div>
                <button onclick="openOrderHub()" class="neu-btn px-6 py-2 text-sm group">
                    <i class="fa-solid fa-user-astronaut mr-2 group-hover:text-purple-400 transition"></i> 
                    <span id="navBtnText">æŸ¥è©¢è¨‚å–®</span>
                </button>
            </div>
        </div>
    </nav>

    <!-- Hero Section -->
    <div class="flex-1 flex items-center justify-center text-center px-4 py-24 mt-10">
        <div class="max-w-4xl animate-fade-in space-y-10">
            <div class="inline-block p-8 rounded-full mb-4" style="box-shadow: var(--shadow-raised);">
                <i class="fa-solid fa-bolt text-6xl text-purple-500 text-glow"></i>
            </div>
            <h1 class="text-5xl md:text-7xl font-bold tracking-tight leading-tight text-gray-200">
                ä½ çš„å°ˆå±¬ <br><span class="text-purple-500 text-glow">é›»ç«¶ç®¡å®¶</span>
            </h1>
            <p class="text-lg md:text-xl text-gray-400 font-light tracking-wide">
                å¤§ç¥ä»£æ‰“ Â· ç”œç¾é™ªç© Â· æ¥µé€Ÿä¸Šåˆ†
            </p>
            
            <div class="pt-4 flex justify-center">
                <button onclick="scrollToOrder()" class="neu-btn neu-btn-primary px-12 py-5 text-xl rounded-2xl">
                    é–‹å§‹é»å–® <i class="fa-solid fa-arrow-down ml-3 animate-bounce"></i>
                </button>
            </div>
        </div>
    </div>

    <!-- Booking Section -->
    <div id="bookingSection" class="min-h-screen py-24 px-4 hidden">
        <div class="max-w-3xl mx-auto">
            <div class="neu-card p-8 md:p-12 relative">
                <h2 class="text-3xl font-bold mb-10 text-center flex items-center justify-center text-gray-200">
                    <span class="w-3 h-3 bg-purple-500 rounded-full mr-4 shadow-[0_0_10px_#a855f7]"></span>
                    é ç´„æœå‹™å–®
                </h2>
                
                <form id="bookingForm" class="space-y-10">
                    <!-- 1. Game -->
                    <div>
                        <label class="text-sm font-bold text-purple-400 uppercase tracking-widest mb-4 block pl-1">01. é¸æ“‡éŠæˆ² <span class="text-red-400">*</span></label>
                        <select id="gameSelect" onchange="onGameChange()" class="w-full neu-input px-6 py-4 text-lg bg-transparent appearance-none cursor-pointer">
                            <option value="">è¼‰å…¥ä¸­...</option>
                        </select>
                        <p id="mockDataMsg" class="text-yellow-500 text-xs mt-3 ml-2 hidden"><i class="fas fa-wifi mr-1"></i>å±•ç¤ºæ¨¡å¼</p>
                    </div>

                    <!-- 2. Booster -->
                    <div id="boosterSection" class="hidden">
                        <label class="text-sm font-bold text-purple-400 uppercase tracking-widest mb-4 block pl-1">02. é¸æ“‡å¤§ç¥</label>
                        <div id="boosterGrid" class="grid grid-cols-2 md:grid-cols-4 gap-6"></div>
                        <input type="hidden" id="selectedBoosterId" value="">
                        <input type="hidden" id="selectedBoosterName" value="">
                        <input type="hidden" id="selectedBoosterPrice" value="0">
                    </div>

                    <!-- 3. Service Type -->
                    <div>
                        <label class="text-sm font-bold text-purple-400 uppercase tracking-widest mb-4 block pl-1">03. æœå‹™é¡å‹</label>
                        <div id="serviceTypeContainer" class="grid grid-cols-2 gap-6"></div>
                    </div>

                    <!-- 4. Dynamic Content -->
                    <div id="dynamicServiceSection" class="grid md:grid-cols-2 gap-8">
                        <!-- A. Hours -->
                        <div id="hoursSection">
                            <label class="text-sm font-bold text-purple-400 uppercase tracking-widest mb-4 block pl-1">04. é ç´„æ™‚æ•¸ <span class="text-red-400">*</span></label>
                            <div class="neu-input px-6 py-3 flex items-center justify-between">
                                <button type="button" onclick="changeHours(-1)" class="w-10 h-10 rounded-full neu-btn text-xl hover:text-red-400">-</button>
                                <div class="text-center">
                                    <span id="displayHours" class="text-2xl font-bold text-white">1</span> <span class="text-xs text-gray-400 block">å°æ™‚</span>
                                </div>
                                <button type="button" onclick="changeHours(1)" class="w-10 h-10 rounded-full neu-btn text-xl hover:text-green-400">+</button>
                            </div>
                            <div id="pricePreview" class="mt-3 text-right hidden px-2">
                                <span class="text-gray-400 text-xs uppercase">Estimated</span> 
                                <span id="totalPriceDisplay" class="text-xl font-bold text-green-400 ml-2">$0</span>
                            </div>
                        </div>
                        <!-- B. Request -->
                        <div id="requestSection" class="hidden md:col-span-2">
                            <label class="text-sm font-bold text-purple-400 uppercase tracking-widest mb-4 block pl-1">04. ä»£æ‰“éœ€æ±‚ <span class="text-red-400">*</span></label>
                            <textarea id="boostRequestInput" rows="3" class="w-full neu-input px-6 py-4" placeholder="ä¾‹å¦‚ï¼šç›®å‰éŠ€ç‰Œ2ï¼Œæƒ³æ‰“åˆ°é‡‘ç‰Œ4..."></textarea>
                            <div class="mt-3 text-right px-2">
                                <span class="text-gray-400 text-xs uppercase">Quote</span> 
                                <span class="text-lg font-bold text-yellow-500 ml-2">ç­‰å¾…å ±åƒ¹</span>
                            </div>
                        </div>
                    </div>

                    <!-- 5. Date & Time -->
                    <div class="grid md:grid-cols-2 gap-8">
                        <div>
                            <label class="text-sm font-bold text-gray-400 mb-2 block pl-1">æ—¥æœŸ <span class="text-red-400">*</span></label>
                            <input type="date" id="dateInput" class="w-full neu-input px-6 py-3 cursor-pointer">
                        </div>
                        <div>
                            <label class="text-sm font-bold text-gray-400 mb-2 block pl-1">æ™‚é–“ <span class="text-red-400">*</span></label>
                            <input type="time" id="timeInput" class="w-full neu-input px-6 py-3 cursor-pointer">
                        </div>
                    </div>

                    <!-- 6. Email -->
                    <div>
                        <label class="text-sm font-bold text-gray-400 mb-2 block pl-1">Email <span class="text-red-400">*</span></label>
                        <input type="email" id="emailInput" placeholder="example@gmail.com" class="w-full neu-input px-6 py-3">
                    </div>

                    <button type="button" onclick="submitInquiry()" class="w-full neu-btn neu-btn-primary py-5 text-lg mt-8">
                        é€å‡ºéœ€æ±‚ <i class="fa-solid fa-paper-plane ml-3"></i>
                    </button>
                </form>
            </div>
        </div>
    </div>

    <!-- Created Modal -->
    <div id="createdModal" class="fixed inset-0 bg-[#292d3e]/90 hidden items-center justify-center z-[60] backdrop-blur-sm">
        <div class="neu-card p-10 w-full max-w-sm text-center animate-fade-in border border-green-500/20">
            <div class="w-24 h-24 rounded-full flex items-center justify-center mx-auto mb-6 text-green-400 text-4xl" style="box-shadow: var(--shadow-inset);">
                <i class="fa-solid fa-check"></i>
            </div>
            <h3 class="text-2xl font-bold text-white mb-3">éœ€æ±‚å·²é€å‡º</h3>
            <p class="text-gray-400 text-sm mb-8">å–®è™Ÿå·²ç”Ÿæˆï¼Œè«‹ä¿å­˜ä»¥ä¾¿æŸ¥è©¢ã€‚</p>
            
            <div class="neu-input p-4 mb-8 cursor-pointer hover:text-purple-400 transition group" onclick="copyCreatedId()">
                <p class="text-[10px] text-gray-500 uppercase tracking-wider mb-2">ORDER ID</p>
                <div class="flex items-center justify-center gap-3">
                    <span id="createdOrderIdText" class="text-3xl font-mono font-bold tracking-widest text-purple-400">---</span>
                    <i class="fa-regular fa-copy text-gray-500 group-hover:text-purple-400"></i>
                </div>
            </div>

            <button onclick="goToHubFromCreated()" class="w-full neu-btn py-4 text-green-400">
                å‰å¾€è¨‚å–®ä¸­å¿ƒ
            </button>
        </div>
    </div>

    <!-- Order Hub (Full Screen) -->
    <div id="orderHub" class="fixed inset-0 z-50 hidden overflow-y-auto" style="background: var(--bg-base);">
        <button onclick="closeOrderHub()" class="absolute top-6 right-6 z-50 w-12 h-12 rounded-full neu-btn text-gray-400 hover:text-red-400"><i class="fa-solid fa-xmark text-xl"></i></button>
        
        <div class="min-h-screen flex flex-col items-center justify-center p-4">
            <!-- Search -->
            <div id="hubSearch" class="w-full max-w-md text-center space-y-8 animate-fade-in">
                <div class="w-24 h-24 rounded-full mx-auto flex items-center justify-center text-purple-500 text-4xl" style="box-shadow: var(--shadow-raised);">
                    <i class="fa-solid fa-magnifying-glass"></i>
                </div>
                <h2 class="text-3xl font-bold text-white">æŸ¥è©¢è¨‚å–®</h2>
                <div class="flex neu-input p-1">
                    <input type="text" id="hubOrderIdInput" placeholder="è¼¸å…¥å–®è™Ÿ (ä¾‹å¦‚: ORD-123456)" class="flex-1 bg-transparent px-6 outline-none text-white placeholder-gray-500">
                    <button onclick="checkStatusInHub()" class="neu-btn px-6 py-2 text-purple-400 hover:bg-gray-800/50">æŸ¥è©¢</button>
                </div>
            </div>

            <!-- Result -->
            <div id="hubResult" class="w-full max-w-5xl hidden grid grid-cols-1 lg:grid-cols-3 gap-8 animate-fade-in">
                <!-- Left: Info -->
                <div class="lg:col-span-1 space-y-8">
                    <div class="neu-card p-8 text-center">
                        <div id="statusIcon" class="w-20 h-20 rounded-full flex items-center justify-center mx-auto mb-6 text-3xl" style="box-shadow: var(--shadow-inset);"><i class="fa-solid fa-spinner fa-spin"></i></div>
                        <h3 id="statusTitle" class="text-xl font-bold text-white">è®€å–ä¸­...</h3>
                        <div class="font-mono mt-3 text-purple-400 text-sm tracking-widest" id="displayOrderId"></div>
                        
                        <div id="userCancelArea" class="mt-8 hidden">
                            <button onclick="cancelOrderUser()" class="w-full neu-btn py-3 text-red-400 text-sm hover:text-red-300">
                                <i class="fa-solid fa-ban mr-2"></i> å–æ¶ˆè¨‚å–®
                            </button>
                        </div>

                        <div id="boosterIdCard" class="hidden mt-8 p-6 rounded-2xl" style="box-shadow: var(--shadow-inset);">
                            <p class="text-[10px] text-gray-500 mb-3 font-bold uppercase tracking-widest">å¤§ç¥éŠæˆ² ID</p>
                            <div class="flex items-center justify-between cursor-pointer group" onclick="copyBoosterId()">
                                <span id="displayBoosterId" class="font-mono font-bold text-white text-xl select-all">---</span>
                                <i class="fa-regular fa-copy text-gray-500 group-hover:text-white"></i>
                            </div>
                        </div>
                    </div>
                    
                    <div id="paymentActionArea" class="neu-card p-8 hidden">
                        <h4 class="text-green-400 font-bold mb-6 text-center uppercase tracking-widest text-sm">ä»˜æ¬¾ç¢ºèª</h4>
                        <div class="mb-6 p-4 rounded-xl flex justify-between items-center" style="box-shadow: var(--shadow-inset);">
                            <span class="text-gray-400 text-sm">æ‡‰ä»˜é‡‘é¡</span>
                            <span id="payAmountDisplay" class="text-2xl font-bold text-white">$0</span>
                        </div>
                        <div class="space-y-4">
                            <input type="text" id="payCard" placeholder="MyCard å¡è™Ÿ" class="w-full neu-input px-4 py-3 text-sm">
                            <input type="text" id="payPwd" placeholder="MyCard å¯†ç¢¼" class="w-full neu-input px-4 py-3 text-sm">
                        </div>
                        <button onclick="submitPayment()" class="w-full neu-btn py-3 mt-6 text-green-400 hover:text-green-300">ç¢ºèªä»˜æ¬¾</button>
                    </div>
                </div>
                
                <!-- Right: Chat -->
                <div class="lg:col-span-2 neu-card overflow-hidden flex flex-col h-[650px]">
                    <div class="p-6 border-b border-white/5 font-bold text-gray-300 flex items-center">
                        <div class="w-3 h-3 rounded-full bg-green-500 mr-3 shadow-[0_0_8px_#22c55e]"></div> å®¢æœ / å¤§ç¥
                    </div>
                    <div id="chatBox" class="flex-1 overflow-y-auto p-6 space-y-4" style="box-shadow: inset 0 0 20px rgba(0,0,0,0.2);"></div>
                    <div class="p-6 border-t border-white/5 flex gap-4">
                        <input type="text" id="chatMsg" class="flex-1 neu-input px-6 py-3" placeholder="è¼¸å…¥è¨Šæ¯...">
                        <button onclick="sendUserMessage()" class="w-14 h-14 rounded-xl neu-btn text-purple-400 text-xl"><i class="fa-solid fa-paper-plane"></i></button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        const GAS_API_URL = "https://script.google.com/macros/s/AKfycbxm6I0lCN82Tnt3gDWPNKptKO9682Jeik-XSJlb9YTGTG4HkY5d-GfwK75HVHWVhQP8/exec";
        
        let allGames = [];
        let currentOrderId = "";
        let isMockMode = false;
        let currentHours = 1;
        let currentServiceType = 'companion'; 
        let lastKnownStatus = "";
        let lastMsgCount = 0;

        function initApp() {
            document.getElementById('dateInput').valueAsDate = new Date();
            fetchGames();
            const savedId = getCookie("gcarry_order");
            if(savedId) {
                document.getElementById('navBtnText').innerText = `æŸ¥è©¢ (${savedId})`;
                openOrderHub(savedId); 
            }
        }

        function requestNotificationPermission() {
            if (!("Notification" in window)) return;
            if (Notification.permission === "default") Notification.requestPermission();
        }
        function sendNotification(title, body) {
            if (Notification.permission === "granted") new Notification(title, { body: body, icon: "https://cdn-icons-png.flaticon.com/512/3225/3225132.png" });
        }

        function fetchGames() {
            fetch(GAS_API_URL + "?action=getGames")
                .then(r => r.ok ? r.json() : Promise.reject())
                .then(data => renderGames(data))
                .catch(() => {
                    isMockMode = true;
                    document.getElementById('mockDataMsg').classList.remove('hidden');
                    renderGames([{id:'lol', name:'è‹±é›„è¯ç›Ÿ (Demo)', companion:true, boost:true}]);
                });
        }

        function renderGames(data) {
            allGames = data;
            const sel = document.getElementById('gameSelect');
            // â˜… ä¿®æ­£ï¼šç§»é™¤ text-gray-800ï¼Œè®“æ–‡å­—é¡è‰²è·Ÿéš¨ CSS è®Šæ•¸
            sel.innerHTML = data.length ? data.map(g => `<option value="${g.id}">${g.name}</option>`).join('') : '<option value="">ç„¡éŠæˆ²</option>';
            onGameChange(); 
        }

        function onGameChange() { updateServiceOptions(); fetchBoosters(); }

        function updateServiceOptions() {
            const gid = document.getElementById('gameSelect').value;
            const g = allGames.find(x => x.id === gid);
            if(!g) return;
            let h = '';
            if(g.companion) h += `<label class="group"><input type="radio" name="serviceType" value="companion" checked class="peer sr-only" onclick="switchService('companion')"><div class="neu-radio-label p-6 text-center text-gray-400 hover:text-gray-200"><i class="fa-solid fa-microphone-lines text-3xl mb-2 block"></i><div class="font-bold text-sm">èªéŸ³é™ªç©</div></div></label>`;
            if(g.boost) h += `<label class="group"><input type="radio" name="serviceType" value="boost" class="peer sr-only" onclick="switchService('boost')"><div class="neu-radio-label p-6 text-center text-gray-400 hover:text-gray-200"><i class="fa-solid fa-trophy text-3xl mb-2 block"></i><div class="font-bold text-sm">æŠ€è¡“ä»£æ‰“</div></div></label>`;
            document.getElementById('serviceTypeContainer').innerHTML = h;
            
            if(g.companion) switchService('companion');
            else if(g.boost) switchService('boost');
        }

        function switchService(type) {
            currentServiceType = type;
            const hoursSec = document.getElementById('hoursSection');
            const reqSec = document.getElementById('requestSection');
            if (!hoursSec || !reqSec) return;
            if(type === 'companion') {
                hoursSec.classList.remove('hidden');
                reqSec.classList.add('hidden');
                updatePricePreview(); 
            } else {
                hoursSec.classList.add('hidden');
                reqSec.classList.remove('hidden');
            }
        }

        function fetchBoosters() {
            const gid = document.getElementById('gameSelect').value;
            const section = document.getElementById('boosterSection');
            const grid = document.getElementById('boosterGrid');
            section.classList.remove('hidden');
            grid.innerHTML = '<div class="col-span-full text-center text-gray-500 py-8"><i class="fa-solid fa-circle-notch fa-spin text-2xl"></i><br>è¼‰å…¥å¤§ç¥ä¸­...</div>';
            selectBooster('','',0); 
            if(isMockMode) { setTimeout(() => renderBoosters(getMockBoosters(gid)), 500); return; }
            fetch(GAS_API_URL + "?action=getBoosters&game=" + gid)
                .then(r => r.json()).then(data => renderBoosters(data)).catch(() => renderBoosters(getMockBoosters(gid)));
        }

        function renderBoosters(list) {
            const grid = document.getElementById('boosterGrid');
            let html = `
                <div onclick="selectBooster('','ç³»çµ±åˆ†é…', 0)" id="booster-random" class="neu-card p-4 text-center cursor-pointer group transition" style="box-shadow: var(--shadow-inset); border-color: var(--accent);">
                    <div class="w-14 h-14 rounded-full mx-auto mb-3 flex items-center justify-center text-2xl text-gray-500 bg-[#292d3e]" style="box-shadow: var(--shadow-raised);">â“</div>
                    <div class="font-bold text-white text-sm">ç³»çµ±åˆ†é…</div>
                    <div class="text-xs text-gray-500 mt-1">å¿«é€Ÿé…å°</div>
                    <div class="absolute top-2 right-2 text-green-500 text-xs"><i class="fa-solid fa-check-circle"></i></div>
                </div>
            `;
            if(list && list.length > 0) {
                html += list.map(b => `
                    <div onclick="selectBooster('${b.id}','${b.name}', '${b.price}')" id="booster-${b.id}" class="neu-card p-4 text-center cursor-pointer group hover:-translate-y-1 transition">
                        <div class="w-14 h-14 rounded-full mx-auto mb-3 overflow-hidden bg-[#292d3e]" style="box-shadow: var(--shadow-inset);">
                            ${b.image ? `<img src="${b.image}" class="w-full h-full object-cover">` : `<div class="w-full h-full flex items-center justify-center text-xl text-gray-500">ğŸ‘¤</div>`}
                        </div>
                        <div class="font-bold text-gray-200 text-sm truncate">${b.name}</div>
                        <div class="text-[10px] text-purple-400 mb-2">${b.rank || 'å¤§ç¥'}</div>
                        <div class="text-xs rounded-lg py-1 px-2 inline-block font-mono text-gray-400" style="box-shadow: var(--shadow-inset);">$${b.price}/H</div>
                    </div>
                `).join('');
            }
            grid.innerHTML = html;
        }

        function selectBooster(id, name, price) {
            document.querySelectorAll('[id^="booster-"]').forEach(el => {
                el.style.boxShadow = "var(--shadow-raised)";
                el.style.borderColor = "rgba(255,255,255,0.05)";
            });
            const targetId = id ? `booster-${id}` : `booster-random`;
            const target = document.getElementById(targetId);
            if(target) {
                target.style.boxShadow = "var(--shadow-inset)";
                target.style.borderColor = "var(--accent)";
            }
            document.getElementById('selectedBoosterId').value = id;
            document.getElementById('selectedBoosterName').value = name;
            const cleanPrice = price ? parseInt(price.toString().replace(/\D/g, '')) : 0;
            document.getElementById('selectedBoosterPrice').value = cleanPrice || 0;
            updatePricePreview();
        }

        function changeHours(delta) {
            currentHours += delta;
            if(currentHours < 1) currentHours = 1;
            document.getElementById('displayHours').innerText = currentHours;
            updatePricePreview();
        }

        function updatePricePreview() {
            const price = parseInt(document.getElementById('selectedBoosterPrice').value) || 0;
            const total = price * currentHours;
            const preview = document.getElementById('pricePreview');
            const display = document.getElementById('totalPriceDisplay');
            if(currentServiceType === 'companion' && price > 0) { 
                preview.classList.remove('hidden'); 
                display.innerText = `$${total}`; 
            } else { 
                preview.classList.add('hidden'); 
            }
        }

        function getMockBoosters(gid) {
            if(gid === 'lol') return [{id:'b1', name:'Faker', rank:'èè‹±', price:'200'}, {id:'b2', name:'Keria', rank:'å®—å¸«', price:'180'}];
            return [];
        }

        function submitInquiry() {
            const btn = document.querySelector('button[onclick="submitInquiry()"]');
            const orgTxt = btn.innerHTML;
            let totalPrice = 0;
            let noteStr = "";

            if(currentServiceType === 'companion') {
                const boosterPrice = parseInt(document.getElementById('selectedBoosterPrice').value) || 0;
                totalPrice = boosterPrice * currentHours;
            } else {
                currentHours = 0; 
                totalPrice = 0;
                const requestText = document.getElementById('boostRequestInput').value;
                if(!requestText) { alert("è«‹å¡«å¯«ä»£æ‰“éœ€æ±‚æè¿°ï¼"); return; }
                noteStr = " [ä»£æ‰“éœ€æ±‚: " + requestText + "]"; 
            }

            const form = {
                action: 'createInquiry',
                game: document.getElementById('gameSelect').value,
                type: currentServiceType,
                boosterId: document.getElementById('selectedBoosterId').value,
                boosterName: document.getElementById('selectedBoosterName').value + noteStr, 
                date: document.getElementById('dateInput').value,
                time: document.getElementById('timeInput').value,
                email: document.getElementById('emailInput').value,
                hours: currentHours,
                totalPrice: totalPrice
            };

            if(!form.game || !form.date || !form.time || !form.email) { alert("è«‹å¡«å¯«å®Œæ•´æ¬„ä½ï¼"); return; }

            btn.innerHTML = '<i class="fa-solid fa-spinner fa-spin"></i>...'; btn.disabled = true;

            if(isMockMode) { setTimeout(() => { showCreatedModal("DEMO-123"); btn.innerHTML=orgTxt; btn.disabled=false; }, 1000); return; }

            fetch(GAS_API_URL, {method:'POST', body:JSON.stringify(form)})
                .then(r=>r.json()).then(d=>{
                    if(d.status==='success') showCreatedModal(d.orderId);
                    else alert(d.message);
                })
                .finally(()=>{ btn.innerHTML=orgTxt; btn.disabled=false; });
        }

        function scrollToOrder() { document.getElementById('bookingSection').classList.remove('hidden'); document.getElementById('bookingSection').scrollIntoView({behavior:'smooth'}); }
        
        function showCreatedModal(orderId) {
            currentOrderId = orderId;
            document.getElementById('createdOrderIdText').innerText = orderId;
            document.getElementById('createdModal').classList.remove('hidden');
            document.getElementById('createdModal').classList.add('flex');
            setCookie("gcarry_order", orderId, 7);
        }

        function copyTextToClipboard(text) {
            const textArea = document.createElement("textarea");
            textArea.value = text;
            textArea.style.position = "fixed";
            textArea.style.left = "-9999px";
            textArea.style.top = "0";
            document.body.appendChild(textArea);
            textArea.focus();
            textArea.select();
            try {
                const successful = document.execCommand('copy');
                document.body.removeChild(textArea);
                if (successful) return Promise.resolve(); else return Promise.reject("è¤‡è£½å¤±æ•—");
            } catch (err) { document.body.removeChild(textArea); return Promise.reject(err); }
        }

        function copyCreatedId() {
            const text = document.getElementById('createdOrderIdText').innerText;
            copyTextToClipboard(text).then(() => alert("å·²è¤‡è£½å–®è™Ÿï¼"));
        }

        function copyBoosterId() {
            const text = document.getElementById('displayBoosterId').innerText;
            copyTextToClipboard(text).then(() => alert("å·²è¤‡è£½ ID"));
        }

        function goToHubFromCreated() {
            document.getElementById('createdModal').classList.add('hidden');
            document.getElementById('createdModal').classList.remove('flex');
            openOrderHub(currentOrderId);
        }

        function openOrderHub(id="") { 
            document.getElementById('orderHub').classList.remove('hidden'); 
            requestNotificationPermission();
            if(id) { 
                document.getElementById('hubSearch').classList.add('hidden'); 
                document.getElementById('hubResult').classList.remove('hidden'); 
                lastKnownStatus = "";
                lastMsgCount = 0;
                checkStatusReal(id, true); 
            }
        }
        function closeOrderHub() { document.getElementById('orderHub').classList.add('hidden'); }
        function checkStatusInHub() { const id=document.getElementById('hubOrderIdInput').value; if(id) openOrderHub(id); }
        
        function checkStatusReal(oid, isFirstLoad = false) {
            currentOrderId = oid;
            document.getElementById('displayOrderId').innerText = oid;
            if(isMockMode || oid.startsWith("DEMO")) { updateHubUI('WaitingPayment', 500, 'HideOnBush'); mockLoadChat(); return; }
            
            fetch(GAS_API_URL, {method:'POST', body:JSON.stringify({action:'checkStatus', orderId:oid})})
            .then(r=>r.json()).then(d=> { 
                if(d.status==='success'){ 
                    updateHubUI(d.orderStatus, d.totalPrice, d.boosterId);
                    if (!isFirstLoad && lastKnownStatus && lastKnownStatus !== d.orderStatus) {
                        if (d.orderStatus === 'WaitingPayment') sendNotification("å°¾åˆ€æ ¸å¿ƒ", "å¤§ç¥å·²æ¥å–®ï¼è«‹å‰å¾€ä»˜æ¬¾ã€‚");
                        if (d.orderStatus === 'Paid') sendNotification("å°¾åˆ€æ ¸å¿ƒ", "ä»˜æ¬¾å·²ç¢ºèªï¼è¨‚å–®æˆç«‹ã€‚");
                        if (d.orderStatus === 'Cancelled') sendNotification("å°¾åˆ€æ ¸å¿ƒ", "æ‚¨çš„è¨‚å–®å·²è¢«å–æ¶ˆã€‚");
                    }
                    lastKnownStatus = d.orderStatus;
                    loadChatMessages(); 
                } else if(isFirstLoad) { alert('æŸ¥ç„¡æ­¤å–®'); } 
            });
        }

        function updateHubUI(s, price, boosterId) {
            const icon = document.getElementById('statusIcon');
            const pay = document.getElementById('paymentActionArea');
            const priceDisplay = document.getElementById('payAmountDisplay');
            const boosterCard = document.getElementById('boosterIdCard');
            const displayBooster = document.getElementById('displayBoosterId');
            const cancelArea = document.getElementById('userCancelArea'); 
            
            pay.classList.add('hidden');
            boosterCard.classList.add('hidden'); 
            cancelArea.classList.add('hidden'); 
            
            if(price && price > 0) priceDisplay.innerText = `$${price}`;
            else priceDisplay.innerText = "å¾…ç®¡ç†å“¡å ±åƒ¹";

            // â˜… ä¿®æ­£ï¼šé‡ç½®åœ–ç¤ºæ¨£å¼ï¼Œé¿å…é¡è‰²è¡çª
            icon.className = "w-20 h-20 rounded-full flex items-center justify-center mx-auto mb-6 text-3xl";
            icon.style.boxShadow = "var(--shadow-inset)";
            icon.style.color = ""; // Clear inline color
            icon.classList.remove('text-red-500', 'text-yellow-500', 'text-blue-500', 'text-green-500', 'animate-pulse', 'text-gray-400');

            // é è¨­æ¨£å¼
            icon.classList.add('text-gray-400');
            
            if(s==='Cancelled') { 
                icon.innerHTML='<i class="fa-solid fa-ban"></i>'; 
                icon.classList.remove('text-gray-400');
                icon.classList.add('text-red-500');
                document.getElementById('statusTitle').innerText="è¨‚å–®å·²å–æ¶ˆ"; return;
            }
            
            if(s==='Inquiry') { 
                icon.innerHTML='<i class="fa-regular fa-clock"></i>'; 
                icon.classList.remove('text-gray-400');
                icon.classList.add('text-yellow-500');
                document.getElementById('statusTitle').innerText="å¯©æ ¸ / å ±åƒ¹ä¸­";
                cancelArea.classList.remove('hidden'); 
            }
            if(s==='WaitingPayment') { 
                icon.innerHTML='<i class="fa-solid fa-file-invoice-dollar"></i>'; 
                icon.classList.remove('text-gray-400');
                icon.classList.add('text-blue-500', 'animate-pulse');
                icon.style.boxShadow = "var(--shadow-raised)"; // Raised when waiting
                document.getElementById('statusTitle').innerText="ç­‰å¾…ä»˜æ¬¾"; 
                pay.classList.remove('hidden'); 
                cancelArea.classList.remove('hidden'); 
            }
            
            if(s==='Paid' || s==='Confirmed') { 
                icon.innerHTML='<i class="fa-solid fa-check"></i>'; 
                icon.classList.remove('text-gray-400');
                icon.classList.add('text-green-500');
                document.getElementById('statusTitle').innerText="è¨‚å–®å·²æˆç«‹";
                if(boosterId) {
                    boosterCard.classList.remove('hidden');
                    displayBooster.innerText = boosterId;
                }
            }
        }

        function cancelOrderUser() {
            if(!confirm("ç¢ºå®šè¦å–æ¶ˆæ­¤è¨‚å–®å—ï¼Ÿ")) return;
            fetch(GAS_API_URL, {method:'POST', body:JSON.stringify({action:'userCancelOrder', orderId:currentOrderId})})
            .then(r=>r.json()).then(d=>{
                if(d.status==='success') { alert("è¨‚å–®å·²æˆåŠŸå–æ¶ˆã€‚"); checkStatusReal(currentOrderId); }
                else alert("å–æ¶ˆå¤±æ•—ï¼š" + d.message);
            });
        }

        function submitPayment() { fetch(GAS_API_URL, {method:'POST', body:JSON.stringify({action:'submitPayment', orderId:currentOrderId, cardId:document.getElementById('payCard').value, cardPwd:document.getElementById('payPwd').value})}).then(r=>r.json()).then(d=>{ if(d.status==='success'){ alert('ä»˜æ¬¾å·²é€å‡º'); checkStatusReal(currentOrderId, true); }}); }
        
        function loadChatMessages() { 
            fetch(GAS_API_URL, {method:'POST', body:JSON.stringify({action:'getMessages', orderId:currentOrderId})})
            .then(r=>r.json()).then(d=>{
                renderChat(d.messages);
                if (lastMsgCount > 0 && d.messages.length > lastMsgCount) {
                    const lastMsg = d.messages[d.messages.length - 1];
                    if (lastMsg.sender === 'Admin') sendNotification("æ–°è¨Šæ¯", "å®¢æœ/å¤§ç¥ï¼š " + lastMsg.text);
                }
                lastMsgCount = d.messages.length;
            }); 
        }

        function renderChat(m) { document.getElementById('chatBox').innerHTML = m.map(x=>`<div class="mb-4 ${x.sender==='User'?'text-right':'text-left'}"><span class="px-5 py-3 rounded-2xl text-sm inline-block max-w-[80%] ${x.sender==='User'?'text-purple-400':'text-gray-400'}" style="box-shadow: var(--shadow-raised)">${x.text}</span></div>`).join(''); }
        function sendUserMessage() { const t=document.getElementById('chatMsg').value; if(t) fetch(GAS_API_URL, {method:'POST', body:JSON.stringify({action:'sendMessage', orderId:currentOrderId, sender:'User', message:t})}).then(()=>{ document.getElementById('chatMsg').value=''; loadChatMessages(); }); }
        function mockLoadChat() { renderChat([{sender:'User', text:'Hi'}, {sender:'Admin', text:'æ­¡è¿!'}]); }
        function setCookie(n,v,d){const e=new Date();e.setTime(e.getTime()+(d*86400000));document.cookie=n+"="+v+";path=/;expires="+e.toUTCString();}
        function getCookie(n){const m=n+"=";const c=document.cookie.split(';');for(let i=0;i<c.length;i++){let x=c[i];while(x.charAt(0)==' ')x=x.substring(1);if(x.indexOf(m)==0)return x.substring(m.length,x.length);}return null;}
        function checkCookieForOrder(){const id=getCookie("gcarry_order"); if(id) document.getElementById('navBtnText').innerText = `æŸ¥è©¢ (${id})`;}
        
        setInterval(()=>{ 
            if(!document.getElementById('orderHub').classList.contains('hidden') && currentOrderId && !isMockMode && !currentOrderId.startsWith("DEMO")) {
                checkStatusReal(currentOrderId, false); 
            }
        }, 10000); 
    </script>
</body>
</html>
