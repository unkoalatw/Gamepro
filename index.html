<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>å°¾åˆ€æ ¸å¿ƒ | å°ˆæ¥­é›»ç«¶é™ªç©ä»£æ‰“å¹³å°</title>
    <!-- è«‹ç¢ºèª output.css èˆ‡æ­¤æª”æ¡ˆåœ¨åŒä¸€ç›®éŒ„ï¼Œæˆ–æ˜¯ä¾æ“šä½ çš„è³‡æ–™å¤¾çµæ§‹ä¿®æ”¹è·¯å¾‘ -->
    <link href="./output.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
</head>
<body class="min-h-screen flex flex-col" onload="initApp()">
    <nav class="fixed w-full z-40 bg-[#292d3e]/95 backdrop-blur-md border-b border-white/5">
        <div class="max-w-7xl mx-auto px-4 md:px-6 h-16 md:h-20 flex justify-between items-center">
            <div class="flex items-center cursor-pointer" onclick="window.scrollTo(0,0)">
                <div class="w-8 h-8 md:w-10 md:h-10 rounded-xl flex items-center justify-center mr-2 md:mr-3 text-purple-400" style="box-shadow: var(--shadow-raised);"><i class="fa-solid fa-gamepad text-base md:text-xl"></i></div>
                <span class="font-bold text-lg md:text-2xl tracking-wide text-gray-200">å°¾åˆ€æ ¸å¿ƒ</span>
            </div>
            <div><button onclick="openOrderHub()" class="neu-btn px-4 py-2 text-xs md:text-sm group"><i class="fa-solid fa-user-astronaut mr-2 group-hover:text-purple-400 transition"></i><span id="navBtnText">è¨‚å–®</span></button></div>
        </div>
    </nav>

    <div class="flex-1 flex items-center justify-center text-center px-4 py-20 md:py-24 mt-10">
        <div class="max-w-4xl animate-fade-in space-y-8 md:space-y-10">
            <div class="inline-block p-6 md:p-8 rounded-full mb-2" style="box-shadow: var(--shadow-raised);"><i class="fa-solid fa-bolt text-4xl md:text-6xl text-purple-500 text-glow"></i></div>
            <h1 class="text-4xl md:text-7xl font-bold tracking-tight leading-tight text-gray-200">ä½ çš„å°ˆå±¬ <br><span class="text-purple-500 text-glow">é›»ç«¶ç®¡å®¶</span></h1>
            <p class="text-base md:text-xl text-gray-400 font-light tracking-wide">å¤§ç¥ä»£æ‰“ Â· ç”œç¾é™ªç© Â· æ¥µé€Ÿä¸Šåˆ†</p>
            <div class="pt-4 flex justify-center"><button onclick="scrollToOrder()" class="neu-btn neu-btn-primary px-8 md:px-12 py-4 md:py-5 text-lg md:text-xl rounded-2xl w-full md:w-auto">é–‹å§‹é»å–® <i class="fa-solid fa-arrow-down ml-3 animate-bounce"></i></button></div>
        </div>
    </div>

    <div id="bookingSection" class="min-h-screen py-12 md:py-24 px-4 hidden">
        <div class="max-w-3xl mx-auto">
            <div class="neu-card p-6 md:p-12 relative">
                <h2 class="text-2xl md:text-3xl font-bold mb-8 md:mb-10 text-center flex items-center justify-center text-gray-200"><span class="w-2 h-2 md:w-3 md:h-3 bg-purple-500 rounded-full mr-3 md:mr-4 shadow-[0_0_10px_#a855f7]"></span>é ç´„æœå‹™å–®</h2>
                <form id="bookingForm" class="space-y-6 md:space-y-10">
                    <div><label class="text-sm font-bold text-purple-400 uppercase tracking-widest mb-3 block pl-1">01. é¸æ“‡éŠæˆ² <span class="text-red-400">*</span></label><select id="gameSelect" onchange="onGameChange()" class="w-full neu-input px-4 md:px-6 py-3 md:py-4 text-base md:text-lg bg-transparent appearance-none cursor-pointer"><option value="">è¼‰å…¥ä¸­...</option></select><p id="mockDataMsg" class="text-yellow-500 text-xs mt-3 ml-2 hidden"><i class="fas fa-wifi mr-1"></i>å±•ç¤ºæ¨¡å¼</p></div>
                    <div id="boosterSection" class="hidden"><label class="text-sm font-bold text-purple-400 uppercase tracking-widest mb-3 block pl-1">02. é¸æ“‡å¤§ç¥</label><div id="boosterGrid" class="grid grid-cols-2 md:grid-cols-4 gap-3 md:gap-6"></div><input type="hidden" id="selectedBoosterId"><input type="hidden" id="selectedBoosterName"><input type="hidden" id="selectedBoosterPrice" value="0"></div>
                    <div><label class="text-sm font-bold text-purple-400 uppercase tracking-widest mb-3 block pl-1">03. æœå‹™é¡å‹</label><div id="serviceTypeContainer" class="grid grid-cols-2 gap-4 md:gap-6"></div></div>
                    <div id="dynamicServiceSection" class="grid md:grid-cols-2 gap-6 md:gap-8">
                        <div id="hoursSection"><label class="text-sm font-bold text-purple-400 uppercase tracking-widest mb-3 block pl-1">04. é ç´„æ™‚æ•¸ <span class="text-red-400">*</span></label><div class="neu-input px-4 md:px-6 py-3 flex items-center justify-between"><button type="button" onclick="changeHours(-1)" class="w-10 h-10 rounded-full neu-btn text-xl hover:text-red-400">-</button><div class="text-center"><span id="displayHours" class="text-2xl font-bold text-white">1</span> <span class="text-xs text-gray-400 block">å°æ™‚</span></div><button type="button" onclick="changeHours(1)" class="w-10 h-10 rounded-full neu-btn text-xl hover:text-green-400">+</button></div><div id="pricePreview" class="mt-3 text-right hidden px-2"><div class="text-gray-400 text-xs">åŸºæœ¬: <span id="basePriceDisplay">$0</span></div><div id="extraFeeDisplay" class="text-gray-400 text-xs hidden">åŠ å€¼: +$0</div><div id="discountDisplay" class="text-green-400 text-xs hidden">æŠ˜æ‰£: -$0</div><div class="mt-1"><span class="text-gray-400 text-xs uppercase">Total</span> <span id="totalPriceDisplay" class="text-xl font-bold text-green-400 ml-2">$0</span></div></div></div>
                        <div id="requestSection" class="hidden md:col-span-2 space-y-6"><div><label class="text-sm font-bold text-purple-400 uppercase tracking-widest mb-3 block pl-1">04. ä»£æ‰“éœ€æ±‚ <span class="text-red-400">*</span></label><textarea id="boostRequestInput" rows="3" class="w-full neu-input px-4 md:px-6 py-4" placeholder="ä¾‹å¦‚ï¼šç›®å‰éŠ€ç‰Œ2ï¼Œæƒ³æ‰“åˆ°é‡‘ç‰Œ4..."></textarea></div><div class="grid md:grid-cols-2 gap-6 md:gap-8"><div><label class="text-sm font-bold text-purple-400 uppercase tracking-widest mb-3 block pl-1">éŠæˆ²å¸³è™Ÿ <span class="text-red-400">*</span></label><input type="text" id="gameAccount" class="w-full neu-input px-4 md:px-6 py-3" placeholder="æ‚¨çš„éŠæˆ²ç™»å…¥å¸³è™Ÿ"></div><div><label class="text-sm font-bold text-purple-400 uppercase tracking-widest mb-3 block pl-1">éŠæˆ²å¯†ç¢¼ <span class="text-red-400">*</span></label><input type="text" id="gamePassword" class="w-full neu-input px-4 md:px-6 py-3" placeholder="æ‚¨çš„éŠæˆ²ç™»å…¥å¯†ç¢¼"></div></div><div class="mt-3 text-right px-2"><span class="text-gray-400 text-xs uppercase">Quote</span> <span class="text-lg font-bold text-yellow-500 ml-2">ç­‰å¾…å ±åƒ¹</span></div></div>
                    </div>
                    <div id="extraOptions" class="grid md:grid-cols-2 gap-6 md:gap-8">
                        <div><label class="text-sm font-bold text-purple-400 uppercase tracking-widest mb-3 block pl-1">æŒ‡å®šè§’è‰² / è·¯ç·š</label><input type="text" id="roleInput" class="w-full neu-input px-4 md:px-6 py-3" placeholder="ä¾‹å¦‚: çŠ½å®¿ / ä¸­è·¯ (é¸å¡«)"></div>
                        <div id="boostAddons" class="hidden"><label class="text-sm font-bold text-purple-400 uppercase tracking-widest mb-3 block pl-1">åŠ å€¼æœå‹™</label><div class="flex flex-col gap-3"><label class="flex items-center text-sm text-gray-300 cursor-pointer"><input type="checkbox" id="optPriority" class="neu-checkbox" onchange="updatePricePreview()"> <span class="ml-2">åŠ æ€¥è™•ç† (+<span id="ratePriorityDisplay">30</span>%)</span></label><div><label class="flex items-center text-sm text-gray-300 cursor-pointer"><input type="checkbox" id="optStream" class="neu-checkbox" onchange="toggleStreamInput()"> <span class="ml-2">æŒ‡å®šç›´æ’­/éŒ„å½± (+<span id="rateStreamDisplay">20</span>%)</span></label><div id="streamInputContainer" class="height-transition"><input type="text" id="streamDetail" class="w-full neu-input px-3 py-2 text-sm mt-2" placeholder="å¹³å°/é »é“/æ¥æ”¶æ–¹å¼"></div></div></div></div>
                    </div>
                    <div class="grid md:grid-cols-2 gap-6 md:gap-8"><div><label class="text-sm font-bold text-gray-400 mb-2 block pl-1">æ—¥æœŸ <span class="text-red-400">*</span></label><input type="date" id="dateInput" class="w-full neu-input px-4 md:px-6 py-3 cursor-pointer"></div><div id="timeSection"><label class="text-sm font-bold text-gray-400 mb-2 block pl-1">æ™‚é–“ <span class="text-red-400">*</span></label><input type="time" id="timeInput" class="w-full neu-input px-4 md:px-6 py-3 cursor-pointer"></div></div>
                    <div class="grid md:grid-cols-2 gap-6 md:gap-8 items-end"><div><label class="text-sm font-bold text-gray-400 mb-2 block pl-1">Email <span class="text-red-400">*</span></label><input type="email" id="emailInput" placeholder="example@gmail.com" class="w-full neu-input px-4 md:px-6 py-3"></div><div><label class="text-sm font-bold text-gray-400 mb-2 block pl-1">å„ªæƒ ç¢¼ (é¸å¡«)</label><div class="flex gap-2"><input type="text" id="couponInput" class="flex-1 neu-input px-4 py-3 uppercase" placeholder="COUPON"><button id="btnVerifyCoupon" type="button" onclick="verifyCoupon()" class="neu-btn px-4 text-purple-400 text-sm">é©—è­‰</button></div><p id="couponMsg" class="text-xs mt-1 h-4"></p></div></div>
                    <div class="flex items-center justify-center gap-2 mt-4"><input type="checkbox" id="agreeTerms" class="neu-checkbox"><label for="agreeTerms" class="text-sm text-gray-400">æˆ‘å·²é–±è®€ä¸¦åŒæ„ <span class="text-purple-400 cursor-pointer underline" onclick="showTermsModal()">æœå‹™æ¢æ¬¾</span></label></div>
                    <button id="submitOrderBtn" type="button" onclick="submitInquiry()" class="w-full neu-btn neu-btn-primary py-4 md:py-5 text-lg mt-8">é€å‡ºéœ€æ±‚ <i class="fa-solid fa-paper-plane ml-3"></i></button>
                </form>
            </div>
        </div>
    </div>

    <!-- Modals -->
    <div id="termsModal" class="fixed inset-0 bg-[#292d3e]/95 hidden items-center justify-center z-[70] backdrop-blur-sm p-4"><div class="neu-card w-full max-w-2xl max-h-[80vh] flex flex-col"><div class="p-6 border-b border-white/5 flex justify-between items-center"><h3 class="text-xl font-bold text-white">æœå‹™æ¢æ¬¾</h3><button onclick="closeTermsModal()" class="neu-btn w-8 h-8 text-gray-400"><i class="fas fa-times"></i></button></div><div id="termsContent" class="p-6 overflow-y-auto text-gray-300 text-sm leading-relaxed whitespace-pre-wrap">è¼‰å…¥ä¸­...</div><div class="p-6 border-t border-white/5 text-right"><button onclick="closeTermsModal()" class="neu-btn px-6 py-2">é—œé–‰</button></div></div></div>
    <div id="createdModal" class="fixed inset-0 bg-[#292d3e]/90 hidden items-center justify-center z-[60] backdrop-blur-sm p-4"><div class="neu-card p-8 md:p-10 w-full max-w-sm text-center animate-fade-in border border-green-500/20"><div class="w-20 h-20 md:w-24 md:h-24 rounded-full flex items-center justify-center mx-auto mb-6 text-green-400 text-3xl md:text-4xl" style="box-shadow: var(--shadow-inset);"><i class="fa-solid fa-check"></i></div><h3 class="text-xl md:text-2xl font-bold text-white mb-3">éœ€æ±‚å·²é€å‡º</h3><p class="text-gray-400 text-sm mb-8">å–®è™Ÿå·²ç”Ÿæˆï¼Œè«‹ä¿å­˜ä»¥ä¾¿æŸ¥è©¢ã€‚</p><div class="neu-input p-4 mb-8 cursor-pointer hover:text-purple-400 transition group" onclick="copyCreatedId()"><p class="text-[10px] text-gray-500 uppercase tracking-wider mb-2">ORDER ID</p><div class="flex items-center justify-center gap-3"><span id="createdOrderIdText" class="text-2xl md:text-3xl font-mono font-bold tracking-widest text-purple-400">---</span><i class="fa-regular fa-copy text-gray-500 group-hover:text-purple-400"></i></div></div><button onclick="goToHubFromCreated()" class="w-full neu-btn py-4 text-green-400">å‰å¾€è¨‚å–®ä¸­å¿ƒ</button></div></div>
    <div id="orderHub" class="fixed inset-0 z-50 hidden overflow-y-auto" style="background: var(--bg-base);"><button onclick="closeOrderHub()" class="absolute top-4 right-4 md:top-6 md:right-6 z-50 w-10 h-10 md:w-12 md:h-12 rounded-full neu-btn text-gray-400 hover:text-red-400"><i class="fa-solid fa-xmark text-lg md:text-xl"></i></button><button id="enableNotifyBtn" onclick="enableNotifications()" class="absolute top-4 right-16 md:top-6 md:right-20 z-50 neu-btn px-3 md:px-4 h-10 md:h-12 text-xs md:text-sm text-yellow-400 hidden hover:text-yellow-300"><i class="fa-solid fa-bell mr-2"></i> <span class="hidden md:inline">é–‹å•Ÿé€šçŸ¥</span><span class="md:hidden">é€šçŸ¥</span></button><div class="min-h-screen flex flex-col items-center justify-center p-4"><div id="hubSearch" class="w-full max-w-md text-center space-y-6 md:space-y-8 animate-fade-in"><div class="w-20 h-20 md:w-24 md:h-24 rounded-full mx-auto flex items-center justify-center text-purple-500 text-3xl md:text-4xl" style="box-shadow: var(--shadow-raised);"><i class="fa-solid fa-magnifying-glass"></i></div><h2 class="text-2xl md:text-3xl font-bold text-white">æŸ¥è©¢è¨‚å–®</h2><div class="flex neu-input p-1"><input type="text" id="hubOrderIdInput" placeholder="è¼¸å…¥å–®è™Ÿ (ä¾‹å¦‚: ORD-123456)" class="flex-1 bg-transparent px-4 md:px-6 outline-none text-white placeholder-gray-500 text-sm md:text-base"><button id="btnCheckStatus" onclick="checkStatusInHub()" class="neu-btn px-4 md:px-6 py-2 text-purple-400 hover:bg-gray-800/50 text-sm md:text-base">æŸ¥è©¢</button></div></div><div id="hubResult" class="w-full max-w-5xl hidden grid grid-cols-1 lg:grid-cols-3 gap-6 md:gap-8 animate-fade-in"><div class="lg:col-span-1 space-y-6 md:space-y-8"><div class="neu-card p-6 md:p-8 text-center"><div id="statusIcon" class="w-16 h-16 md:w-20 md:h-20 rounded-full flex items-center justify-center mx-auto mb-4 md:mb-6 text-2xl md:text-3xl" style="box-shadow: var(--shadow-inset);"><i class="fa-solid fa-spinner fa-spin"></i></div><h3 id="statusTitle" class="text-lg md:text-xl font-bold text-white">è®€å–ä¸­...</h3><div class="font-mono mt-3 text-purple-400 text-xs md:text-sm tracking-widest" id="displayOrderId"></div><div id="userCancelArea" class="mt-6 md:mt-8 hidden"><button id="cancelOrderBtn" onclick="cancelOrderUser()" class="w-full neu-btn py-3 text-red-400 text-sm hover:text-red-300"><i class="fa-solid fa-ban mr-2"></i> å–æ¶ˆè¨‚å–®</button></div><div id="newOrderArea" class="mt-6 md:mt-8 hidden"><button id="btnNewOrder" onclick="startNewOrder()" class="w-full neu-btn py-3 text-purple-400 text-sm hover:text-purple-300"><i class="fa-solid fa-rotate-right mr-2"></i> é–‹å•Ÿæ–°è¨‚å–® (æ¸…é™¤èˆŠå–®)</button></div><div id="boosterIdCard" class="hidden mt-6 md:mt-8 p-4 md:p-6 rounded-2xl" style="box-shadow: var(--shadow-inset);"><p class="text-[10px] text-gray-500 mb-2 md:mb-3 font-bold uppercase tracking-widest">å¤§ç¥éŠæˆ² ID</p><div class="flex items-center justify-between cursor-pointer group" onclick="copyBoosterId()"><span id="displayBoosterId" class="font-mono font-bold text-white text-lg md:text-xl select-all truncate mr-2">---</span><i class="fa-regular fa-copy text-gray-500 group-hover:text-white"></i></div></div></div><div id="paymentActionArea" class="neu-card p-6 md:p-8 hidden"><h4 class="text-green-400 font-bold mb-4 md:mb-6 text-center uppercase tracking-widest text-sm">ä»˜æ¬¾ç¢ºèª</h4><div class="mb-4 md:mb-6 p-4 rounded-xl flex justify-between items-center" style="box-shadow: var(--shadow-inset);"><span class="text-gray-400 text-sm">æ‡‰ä»˜é‡‘é¡</span><span id="payAmountDisplay" class="text-xl md:text-2xl font-bold text-white">$0</span></div><div class="bg-[#212432] p-4 rounded-lg mb-4 text-xs text-gray-400 whitespace-pre-wrap font-mono" id="paymentNoticeDisplay" style="box-shadow: var(--shadow-inset)">è¼‰å…¥åŒ¯æ¬¾è³‡è¨Šä¸­...</div><div class="space-y-3 md:space-y-4"><input type="text" id="payCard" placeholder="MyCard å¡è™Ÿ" class="w-full neu-input px-4 py-3 text-sm" oninput="this.value = this.value.toUpperCase()" maxlength="10"><input type="text" id="payPwd" placeholder="MyCard å¯†ç¢¼" class="w-full neu-input px-4 py-3 text-sm"></div><button id="submitPaymentBtn" onclick="submitPayment()" class="w-full neu-btn py-3 mt-6 text-green-400 hover:text-green-300">ç¢ºèªä»˜æ¬¾</button></div></div><div class="lg:col-span-2 neu-card overflow-hidden flex flex-col h-[500px] md:h-[650px]"><div class="p-4 md:p-6 border-b border-white/5 font-bold text-gray-300 flex items-center text-sm md:text-base"><div class="w-2 h-2 md:w-3 md:h-3 rounded-full bg-green-500 mr-2 md:mr-3 shadow-[0_0_8px_#22c55e]"></div> å®¢æœ / å¤§ç¥</div><div id="chatBox" class="flex-1 overflow-y-auto p-4 md:p-6 space-y-3 md:space-y-4" style="box-shadow: inset 0 0 20px rgba(0,0,0,0.2);"></div><div class="p-4 md:p-6 border-t border-white/5 flex gap-3 md:gap-4 items-center"><input type="text" id="chatMsg" class="flex-1 neu-input px-4 md:px-6 py-2 md:py-3 text-sm md:text-base" placeholder="è¼¸å…¥è¨Šæ¯..."><button id="btnSendMsg" onclick="sendUserMessage()" class="w-10 h-10 md:w-14 md:h-14 rounded-xl neu-btn text-purple-400 text-lg md:text-xl flex-shrink-0"><i class="fa-solid fa-paper-plane"></i></button></div></div></div></div></div>
    <!-- è‡ªå®šç¾©æ‡¸æµ®è¦–çª— -->
    <div id="customModal" class="fixed inset-0 z-[100] hidden items-center justify-center bg-black/60 backdrop-blur-sm p-4 animate-fade-in"><div class="neu-card p-6 md:p-8 max-w-sm w-full relative text-center flex flex-col items-center"><div id="modalIconContainer" class="w-16 h-16 rounded-full flex items-center justify-center mb-5 text-3xl" style="box-shadow: var(--shadow-raised);"><i id="modalIcon" class="fa-solid"></i></div><h3 id="modalTitle" class="text-xl font-bold text-white mb-2">æç¤º</h3><p id="modalMsg" class="text-gray-400 text-sm mb-8 leading-relaxed">...</p><div id="modalAlertBtns" class="w-full hidden"><button onclick="closeCustomModal()" class="w-full neu-btn py-3 text-purple-400">ç¢ºå®š</button></div><div id="modalConfirmBtns" class="w-full hidden grid grid-cols-2 gap-4"><button onclick="closeCustomModal()" class="neu-btn py-3 text-gray-400">å–æ¶ˆ</button><button id="modalConfirmActionBtn" class="neu-btn py-3 text-red-400">ç¢ºå®š</button></div></div></div>

    <script>
        const GAS_API_URL="https://script.google.com/macros/s/AKfycbxm6I0lCN82Tnt3gDWPNKptKO9682Jeik-XSJlb9YTGTG4HkY5d-GfwK75HVHWVhQP8/exec";
        let allGames=[], currentOrderId="", isMockMode=false, currentHours=1, currentServiceType='companion', lastKnownStatus="", lastMsgCount=0, activeDiscount=0, globalSettings={terms:"è¼‰å…¥ä¸­...",payment_notice:"è¼‰å…¥ä¸­...",priority_rate:0.3,stream_rate:0.2}, confirmCallback=null;
        const $ = id => document.getElementById(id);
        const apiCall = (data) => fetch(GAS_API_URL, {method:'POST', body:JSON.stringify(data)}).then(r=>r.json());

        function initApp() { $('dateInput').valueAsDate=new Date(); fetchGames(); fetchSettings(); const savedId=localStorage.getItem("gcarry_order"); if(savedId) { $('navBtnText').innerText=`è¨‚å–®`; openOrderHub(savedId); } }
        function showModal(title, msg, type='info', onConfirm=null) {
            $('modalTitle').innerText=title; $('modalMsg').innerText=msg; const icon=$('modalIcon'), box=$('modalIconContainer');
            box.className="w-16 h-16 rounded-full flex items-center justify-center mb-5 text-3xl " + (type==='error'?'text-red-500':type==='success'?'text-green-500':type==='confirm'?'text-yellow-500':'text-purple-500');
            box.style.boxShadow = type==='success'?"var(--shadow-inset)":"var(--shadow-raised)";
            icon.className = `fa-solid ${type==='error'?'fa-xmark':type==='success'?'fa-check':type==='confirm'?'fa-question':'fa-info'}`;
            $('modalAlertBtns').classList.toggle('hidden', !!onConfirm); $('modalConfirmBtns').classList.toggle('hidden', !onConfirm);
            if(onConfirm) { confirmCallback=onConfirm; $('modalConfirmActionBtn').onclick = () => { if(confirmCallback) confirmCallback(); closeModal(); }; }
            $('customModal').classList.remove('hidden'); $('customModal').classList.add('flex');
        }
        const closeModal = () => { $('customModal').classList.add('hidden'); $('customModal').classList.remove('flex'); confirmCallback=null; };
        const showAlert = (t,m,type) => showModal(t,m,type); const showConfirm = (t,m,cb) => showModal(t,m,'confirm',cb);

        function requestNotificationPermission() { if(!("Notification" in window)) return; const btn=$('enableNotifyBtn'); btn.classList.toggle('hidden', Notification.permission!=='default'); }
        function enableNotifications() { if(!("Notification" in window)) return showAlert("æç¤º", "ä¸æ”¯æ´é€šçŸ¥", "error"); Notification.requestPermission().then(p=>{ if(p==="granted") { showAlert("æˆåŠŸ", "é€šçŸ¥å·²é–‹å•Ÿ", "success"); sendNotification("æ¸¬è©¦", "åŠŸèƒ½æ­£å¸¸"); } requestNotificationPermission(); }); }
        function sendNotification(t,b) { if(Notification.permission==="granted") new Notification(t,{body:b,icon:"https://cdn-icons-png.flaticon.com/512/3225/3225132.png"}); }
        
        function fetchSettings() { fetch(GAS_API_URL+"?action=getSettings").then(r=>r.json()).then(d=>{ globalSettings=d; $('paymentNoticeDisplay').innerText=d.payment_notice||"âš ï¸ å°šç„¡è³‡è¨Š"; $('ratePriorityDisplay').innerText=Math.round(d.priority_rate*100); $('rateStreamDisplay').innerText=Math.round(d.stream_rate*100); }).catch(e=>console.error(e)); }
        const showTermsModal = () => { $('termsContent').innerText=globalSettings.terms; $('termsModal').classList.remove('hidden'); $('termsModal').classList.add('flex'); };
        const closeTermsModal = () => { $('termsModal').classList.add('hidden'); $('termsModal').classList.remove('flex'); };
        function fetchGames() { fetch(GAS_API_URL+"?action=getGames").then(r=>r.ok?r.json():Promise.reject()).then(d=>renderGames(d)).catch(()=>{ isMockMode=true; $('mockDataMsg').classList.remove('hidden'); renderGames([{id:'lol',name:'è‹±é›„è¯ç›Ÿ (Demo)',companion:true,boost:true}]); }); }
        function renderGames(d) { allGames=d; $('gameSelect').innerHTML=d.length?d.map(g=>`<option value="${g.id}" class="text-white bg-[#292d3e]">${g.name}</option>`).join(''):'<option value="">ç„¡éŠæˆ²</option>'; onGameChange(); }
        function onGameChange() { updateServiceOptions(); fetchBoosters(); }
        function updateServiceOptions() { const gid=$('gameSelect').value, g=allGames.find(x=>x.id===gid); if(!g) return; let h=''; 
            if(g.companion) h+=`<label class="group"><input type="radio" name="serviceType" value="companion" checked class="peer sr-only" onclick="switchService('companion')"><div class="neu-radio-label p-4 md:p-6 text-center text-gray-400 hover:text-gray-200"><i class="fa-solid fa-microphone-lines text-2xl md:text-3xl mb-2 block"></i><div class="font-bold text-xs md:text-sm">èªéŸ³é™ªç©</div></div></label>`;
            if(g.boost) h+=`<label class="group"><input type="radio" name="serviceType" value="boost" class="peer sr-only" onclick="switchService('boost')"><div class="neu-radio-label p-4 md:p-6 text-center text-gray-400 hover:text-gray-200"><i class="fa-solid fa-trophy text-2xl md:text-3xl mb-2 block"></i><div class="font-bold text-xs md:text-sm">æŠ€è¡“ä»£æ‰“</div></div></label>`;
            $('serviceTypeContainer').innerHTML=h; if(g.companion) switchService('companion'); else if(g.boost) switchService('boost'); }
        function toggleStreamInput() { $('streamInputContainer').classList.toggle('show', $('optStream').checked); updatePricePreview(); }
        function switchService(t) { currentServiceType=t; 
            if(t==='companion') { $('hoursSection').classList.remove('hidden'); $('requestSection').classList.add('hidden'); $('boosterSection').classList.remove('hidden'); $('timeSection').classList.remove('hidden'); $('boostAddons').classList.add('hidden'); $('optPriority').checked=false; $('optStream').checked=false; $('streamInputContainer').classList.remove('show'); updatePricePreview(); }
            else { $('hoursSection').classList.add('hidden'); $('requestSection').classList.remove('hidden'); $('boosterSection').classList.add('hidden'); $('timeSection').classList.add('hidden'); $('boostAddons').classList.remove('hidden'); selectBooster('','',0); } }
        function fetchBoosters() { if(currentServiceType==='boost') return; const gid=$('gameSelect').value; $('boosterGrid').innerHTML='<div class="col-span-full text-center text-gray-500 py-8"><i class="fa-solid fa-circle-notch fa-spin"></i><br>è¼‰å…¥ä¸­...</div>'; selectBooster('','',0); if(isMockMode) return setTimeout(()=>renderBoosters(getMockBoosters(gid)),500); fetch(GAS_API_URL+"?action=getBoosters&game="+gid).then(r=>r.json()).then(d=>renderBoosters(d)).catch(()=>renderBoosters(getMockBoosters(gid))); }
        function renderBoosters(list) { let html=`<div onclick="selectBooster('','ç³»çµ±åˆ†é…',0)" id="booster-random" class="neu-card p-3 md:p-4 text-center cursor-pointer group transition" style="box-shadow:var(--shadow-inset);border-color:var(--accent);"><div class="w-12 h-12 md:w-14 md:h-14 rounded-full mx-auto mb-2 md:mb-3 flex items-center justify-center text-xl md:text-2xl text-gray-500 bg-[#292d3e]" style="box-shadow:var(--shadow-raised);">â“</div><div class="font-bold text-white text-xs md:text-sm">ç³»çµ±åˆ†é…</div><div class="absolute top-2 right-2 text-green-500 text-xs"><i class="fa-solid fa-check-circle"></i></div></div>`;
            if(list&&list.length) html+=list.map(b=>`<div onclick="selectBooster('${b.id}','${b.name}','${b.price}')" id="booster-${b.id}" class="neu-card p-3 md:p-4 text-center cursor-pointer group hover:-translate-y-1 transition"><div class="w-12 h-12 md:w-14 md:h-14 rounded-full mx-auto mb-2 md:mb-3 overflow-hidden bg-[#292d3e]" style="box-shadow:var(--shadow-inset);">${b.image?`<img src="${b.image}" class="w-full h-full object-cover">`:`<div class="w-full h-full flex items-center justify-center text-xl text-gray-500">ğŸ‘¤</div>`}</div><div class="font-bold text-gray-200 text-xs md:text-sm truncate">${b.name}</div><div class="text-[10px] text-purple-400 mb-1">${b.rank||'å¤§ç¥'}</div><div class="text-[10px] md:text-xs rounded-lg py-1 px-2 inline-block font-mono text-gray-400" style="box-shadow:var(--shadow-inset);">$${b.price}/H</div></div>`).join(''); $('boosterGrid').innerHTML=html; }
        function selectBooster(id,n,p) { document.querySelectorAll('[id^="booster-"]').forEach(el=>{el.style.boxShadow="var(--shadow-raised)";el.style.borderColor="rgba(255,255,255,0.05)"}); const t=$(id?`booster-${id}`:`booster-random`); if(t){t.style.boxShadow="var(--shadow-inset)";t.style.borderColor="var(--accent)"} $('selectedBoosterId').value=id; $('selectedBoosterName').value=n; $('selectedBoosterPrice').value=p?parseInt(p.toString().replace(/\D/g,'')):0; updatePricePreview(); }
        function changeHours(d) { currentHours+=d; if(currentHours<1) currentHours=1; $('displayHours').innerText=currentHours; updatePricePreview(); }
        function updatePricePreview() { const p=parseInt($('selectedBoosterPrice').value)||0; if(currentServiceType==='companion'&&p>0) { let t=p*currentHours, ft=t-activeDiscount; if(ft<0) ft=0; $('pricePreview').classList.remove('hidden'); $('basePriceDisplay').innerText=`$${t}`; $('extraFeeDisplay').classList.add('hidden'); $('discountDisplay').innerText=`æŠ˜æ‰£: -$${activeDiscount}`; $('discountDisplay').classList.toggle('hidden', activeDiscount<=0); $('totalPriceDisplay').innerText=`$${ft}`; } else $('pricePreview').classList.add('hidden'); }
        function verifyCoupon() { const c=$('couponInput').value.trim(), btn=$('btnVerifyCoupon'); if(!c) return; lockBtn(btn,true); $('couponMsg').innerText="é©—è­‰ä¸­...";
            if(isMockMode) { activeDiscount=c==="DEMO"?50:0; $('couponMsg').innerText=activeDiscount?"æœ‰æ•ˆ!":"ç„¡æ•ˆ"; lockBtn(btn,false); updatePricePreview(); return; }
            apiCall({action:'checkCoupon',code:c}).then(d=>{ activeDiscount=d.status==='success'?parseInt(d.value):0; $('couponMsg').innerText=activeDiscount?"æœ‰æ•ˆ!":d.message; updatePricePreview(); }).finally(()=>lockBtn(btn,false)); }
        function getMockBoosters(g) { return g==='lol'?[{id:'b1',name:'Faker',rank:'èè‹±',price:'200'},{id:'b2',name:'Keria',rank:'å®—å¸«',price:'180'}]:[]; }
        function lockBtn(b, l, t='<i class="fa-solid fa-spinner fa-spin"></i>') { if(l) { b.setAttribute('data-org', b.innerHTML); b.innerHTML=t; b.disabled=true; } else { b.innerHTML=b.getAttribute('data-org'); b.disabled=false; } }

        function submitInquiry() {
            if(localStorage.getItem("gcarry_order")) return openOrderHub(localStorage.getItem("gcarry_order")) || showAlert("æç¤º", "æ‚¨å·²æœ‰é€²è¡Œä¸­è¨‚å–®", "error");
            const btn=$('submitOrderBtn'); let total=0, note=""; const pR=Math.round(globalSettings.priority_rate*100), sR=Math.round(globalSettings.stream_rate*100);
            let opts=[]; if(currentServiceType==='boost'){ if($('optPriority').checked) opts.push(`åŠ æ€¥(+${pR}%)`); if($('optStream').checked) opts.push(`ç›´æ’­(+${sR}%)${$('streamDetail').value?': '+$('streamDetail').value:''}`); }
            if(currentServiceType==='companion') total=parseInt($('totalPriceDisplay').innerText.replace('$',''))||0; else { currentHours=0; note=` [éœ€æ±‚: ${$('boostRequestInput').value}]`; if(!note.includes('éœ€æ±‚')) return showAlert("æ¬„ä½", "è«‹å¡«éœ€æ±‚", "error"); }
            let acc="", pwd=""; if(currentServiceType==='boost') { acc=$('gameAccount').value; pwd=$('gamePassword').value; if(!acc||!pwd) return showAlert("æ¬„ä½", "è«‹å¡«å¸³å¯†", "error"); }
            if(!$('agreeTerms').checked) return showAlert("æç¤º", "è«‹åŒæ„æ¢æ¬¾", "error");
            const f = { action:'createInquiry', game:$('gameSelect').value, type:currentServiceType, boosterId:$('selectedBoosterId').value, boosterName:$('selectedBoosterName').value+note, date:$('dateInput').value, time:currentServiceType==='companion'?$('timeInput').value:"ç„¡", email:$('emailInput').value, hours:currentHours, totalPrice:total, role:$('roleInput').value, options:opts.join(", "), coupon:$('couponInput').value, discount:activeDiscount, account:acc, password:pwd };
            if(!f.game||!f.date||!f.email) return showAlert("æ¬„ä½", "è«‹å¡«å®Œæ•´", "error");
            if(currentServiceType==='companion'&&!f.time) return showAlert("æ¬„ä½", "è«‹é¸æ™‚é–“", "error");
            lockBtn(btn, true, 'è™•ç†ä¸­...');
            if(isMockMode) return setTimeout(()=>{showCreated("DEMO-123");lockBtn(btn,false)},1000);
            apiCall(f).then(d=>{ if(d.status==='success') showCreated(d.orderId); else showAlert("éŒ¯èª¤", d.message, "error"); }).catch(e=>showAlert("éŒ¯èª¤", e, "error")).finally(()=>lockBtn(btn,false));
        }
        const scrollToOrder = () => { $('bookingSection').classList.remove('hidden'); $('bookingSection').scrollIntoView({behavior:'smooth'}); };
        const showCreated = (id) => { currentOrderId=id; $('createdOrderIdText').innerText=id; $('createdModal').classList.remove('hidden'); $('createdModal').classList.add('flex'); localStorage.setItem("gcarry_order", id); };
        const copyText = (t) => { const a=document.createElement("textarea"); a.value=t; document.body.appendChild(a); a.select(); document.execCommand('copy'); document.body.removeChild(a); showAlert("æˆåŠŸ", "å·²è¤‡è£½", "success"); };
        const copyCreatedId = () => copyText($('createdOrderIdText').innerText); const copyBoosterId = () => copyText($('displayBoosterId').innerText);
        const goToHubFromCreated = () => { $('createdModal').classList.add('hidden'); $('createdModal').classList.remove('flex'); openOrderHub(currentOrderId); };
        
        async function checkStatusInHub() { const id=$('hubOrderIdInput').value, btn=$('btnCheckStatus'); if(id) { lockBtn(btn, true); await openOrderHub(id); lockBtn(btn, false); } }
        function openOrderHub(id="") { $('orderHub').classList.remove('hidden'); requestNotificationPermission(); if(id) { $('hubSearch').classList.add('hidden'); $('hubResult').classList.remove('hidden'); lastKnownStatus=""; lastMsgCount=0; return checkStatusReal(id, true); } return Promise.resolve(); }
        const closeOrderHub = () => $('orderHub').classList.add('hidden');
        
        function checkStatusReal(oid, first=false) {
            currentOrderId=oid; $('displayOrderId').innerText=oid; if(isMockMode||oid.startsWith("DEMO")) { updateHubUI('WaitingPayment',500,'HideOnBush'); mockLoadChat(); return Promise.resolve(); }
            return apiCall({action:'checkStatus', orderId:oid}).then(d=>{
                if(d.status==='success') { updateHubUI(d.orderStatus, d.totalPrice, d.boosterId); if(!first&&lastKnownStatus!==d.orderStatus) sendNotification("æ›´æ–°", `è¨‚å–®ç‹€æ…‹: ${d.orderStatus}`); lastKnownStatus=d.orderStatus; loadChatMessages(); }
                else { if(localStorage.getItem("gcarry_order")===oid) { renderError("è¨‚å–®å¤±æ•ˆ", "fa-triangle-exclamation", "text-yellow-500"); $('newOrderArea').classList.remove('hidden'); if(first) showAlert("å¤±æ•ˆ", "è¨‚å–®å·²ç§»é™¤", "error"); } else if(first) { showAlert("å¤±æ•—", "æŸ¥ç„¡æ­¤å–®", "error"); renderError("æŸ¥ç„¡æ­¤å–®", "fa-circle-question", "text-gray-500"); } }
            }).catch(()=>first&&showAlert("éŒ¯èª¤", "é€£ç·šå¤±æ•—", "error"));
        }
        function renderError(t,i,c) { $('statusTitle').innerText=t; $('statusIcon').className=`w-16 h-16 md:w-20 md:h-20 rounded-full flex items-center justify-center mx-auto mb-6 text-2xl md:text-3xl ${c}`; $('statusIcon').innerHTML=`<i class="fa-solid ${i}"></i>`; ['paymentActionArea','userCancelArea','boosterIdCard','newOrderArea'].forEach(x=>$(x).classList.add('hidden')); }
        function updateHubUI(s,p,bid) {
            const els={pay:$('paymentActionArea'), card:$('boosterIdCard'), cancel:$('userCancelArea'), new:$('newOrderArea'), icon:$('statusIcon')};
            Object.values(els).forEach(e=>e.classList.add('hidden')); $('payAmountDisplay').innerText=p>0?`$${p}`:"å¾…å ±åƒ¹";
            els.icon.className="w-16 h-16 md:w-20 md:h-20 rounded-full flex items-center justify-center mx-auto mb-6 text-2xl md:text-3xl"; els.icon.style.boxShadow="var(--shadow-inset)"; els.icon.classList.remove('text-red-500','text-yellow-500','text-blue-500','text-green-500','animate-pulse','text-gray-400');
            const setStatus = (txt, col, ic, show=[]) => { $('statusTitle').innerText=txt; els.icon.classList.add(col); if(col==='text-blue-500') els.icon.classList.add('animate-pulse'); els.icon.innerHTML=`<i class="fa-solid ${ic}"></i>`; show.forEach(k=>els[k].classList.remove('hidden')); };
            if(s==='Cancelled') setStatus("è¨‚å–®å·²å–æ¶ˆ", "text-red-500", "fa-ban", ['new']);
            else if(s==='Inquiry') setStatus("å¯©æ ¸ / å ±åƒ¹ä¸­", "text-yellow-500", "fa-clock", ['cancel']);
            else if(s==='WaitingPayment') setStatus("ç­‰å¾…ä»˜æ¬¾", "text-blue-500", "fa-file-invoice-dollar", ['pay','cancel']);
            else if(s==='Paid'||s==='Confirmed') { setStatus("è¨‚å–®å·²æˆç«‹", "text-green-500", "fa-check"); if(bid){els.card.classList.remove('hidden'); $('displayBoosterId').innerText=bid;} if(s==='Confirmed') els.new.classList.remove('hidden'); }
        }
        function startNewOrder() { const btn=$('btnNewOrder'); lockBtn(btn,true); showConfirm("é–‹å•Ÿæ–°å–®", "ç¢ºå®šæ¸…é™¤èˆŠå–®ç´€éŒ„ï¼Ÿ", ()=>{ localStorage.removeItem("gcarry_order"); location.reload(); }); setTimeout(()=>lockBtn(btn,false),500); }
        function cancelOrderUser() { showConfirm("å–æ¶ˆè¨‚å–®", "ç¢ºå®šå–æ¶ˆï¼Ÿç„¡æ³•å¾©åŸã€‚", ()=>{ const btn=$('cancelOrderBtn'); lockBtn(btn,true,'å–æ¶ˆä¸­...'); apiCall({action:'userCancelOrder',orderId:currentOrderId}).then(d=>{ if(d.status==='success') { showAlert("æˆåŠŸ","å·²å–æ¶ˆ","success"); checkStatusReal(currentOrderId); } else showAlert("éŒ¯èª¤",d.message,"error"); }).finally(()=>lockBtn(btn,false)); }); }
        function submitPayment() { const c=$('payCard').value.trim(), p=$('payPwd').value.trim(), btn=$('submitPaymentBtn'); if(!/^[A-Z0-9]{10}$/.test(c)) return showAlert("æ ¼å¼","å¡è™Ÿéœ€10ç¢¼è‹±æ•¸","error"); if(!p) return showAlert("æ¬„ä½","è«‹å¡«å¯†ç¢¼","error"); lockBtn(btn,true,'è™•ç†ä¸­...'); apiCall({action:'submitPayment', orderId:currentOrderId, cardId:c, cardPwd:p}).then(d=>{ if(d.status==='success') { showAlert("æˆåŠŸ","å·²é€å‡º","success"); checkStatusReal(currentOrderId,true); } else showAlert("éŒ¯èª¤","ä»˜æ¬¾å¤±æ•—","error"); }).finally(()=>lockBtn(btn,false)); }
        function loadChatMessages() { apiCall({action:'getMessages',orderId:currentOrderId}).then(d=>{ renderChat(d.messages); if(lastMsgCount>0 && d.messages.length>lastMsgCount && d.messages.at(-1).sender==='Admin') sendNotification("æ–°è¨Šæ¯", "å®¢æœ/å¤§ç¥å‚³ä¾†è¨Šæ¯"); lastMsgCount=d.messages.length; }); }
        function renderChat(m) { $('chatBox').innerHTML=m.map(x=>`<div class="mb-4 ${x.sender==='User'?'text-right':'text-left'}"><span class="px-5 py-3 rounded-2xl text-xs md:text-sm inline-block max-w-[80%] ${x.sender==='User'?'text-purple-400':'text-gray-400'}" style="box-shadow:var(--shadow-raised)">${x.text}</span></div>`).join(''); }
        function sendUserMessage() { const t=$('chatMsg').value, btn=$('btnSendMsg'); if(t) { lockBtn(btn,true); apiCall({action:'sendMessage',orderId:currentOrderId,sender:'User',message:t}).then(()=>{ $('chatMsg').value=''; loadChatMessages(); }).finally(()=>lockBtn(btn,false)); } }
        function mockLoadChat() { renderChat([{sender:'User',text:'Hi'},{sender:'Admin',text:'æ­¡è¿!'}]); }
        setInterval(()=>{ if(!$('orderHub').classList.contains('hidden')&&currentOrderId&&!isMockMode) checkStatusReal(currentOrderId); }, 10000);
    </script>
</body>
</html>